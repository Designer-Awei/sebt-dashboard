# SEBT 平衡测试系统更新日志

## [v1.0.6] - 2025-12-22

### ✨ 新增功能

#### 自动锁定功能
- **开始实验按钮**：在主页面controls区域新增"开始实验"按钮
- **实验状态管理**：新增实验运行状态（`experimentRunning`），支持开始/停止实验
- **自动锁定逻辑**：当同一方向连续达到N次（可配置，默认10次）为最近距离时，自动锁定该方向
- **实验状态显示**：在main-content容器左上角添加实验状态显示组件，显示实验运行状态和时长（分:秒格式）
- **状态互斥**：锁定期间，绿色实时高亮暂停显示，避免视觉冲突

#### AutoRun功能
- **AutoRun开关**：将"开启/关闭锁定"滑块重命名为"AutoRun - 锁定&测距"
- **自动化流程**：开启AutoRun后，自动执行"锁定→测距→下一个方向"的完整循环
- **智能方向选择**：自动选择未完成测距方向中最近的方向进行锁定和测距
- **完全自动化**：无需手动点击测距按钮，系统自动完成所有方向的测试

### 🔧 功能优化

#### 锁定和测距流程优化
- **锁定状态管理**：确保同一时间只能存在一个锁定方向
- **锁定后即时反馈**：锁定后立即显示蓝色高亮，不再显示绿色高亮
- **测距按钮优化**：锁定后自动显示测距按钮，点击一次即可开始测距（无需先选择卡片）
- **测距数据收集**：使用第一手数据（`handleHostBroadcast`）进行测距数据收集，确保数据准确性
- **测距完成反馈**：测距完成后立即显示"计算中..."状态，直到最终读数固定

#### UI/UX优化
- **日志滚动方向**：事件日志改为从上到下刷新（新日志出现在旧日志下方），自动滚动到最新日志
- **日志精简**：精简日志内容，移除重复和琐碎信息
  - 锁定日志：只显示方向，不显示距离（`🔒 锁定方向: 后`）
  - 测距日志：统一为"测距完成"，不区分手动/自动（`📐 测距完成: 后 - 76mm`）
  - 移除"开始测距"、"手动测距"、"前端自动锁定"等冗余日志
- **按钮状态优化**：修复"开始实验"按钮切换为"停止实验"时的margin-top重复问题
- **高亮互斥**：确保绿色实时高亮和蓝色锁定高亮完全互斥，不会同时显示

#### 数据处理优化
- **数据有效性判断移除**：删除软件端对传入数据数值有效性的判断逻辑，直接使用真实的传入数据
- **数据更新流畅度**：优化从数据接收到锁定判断的处理链路，提高实时性
  - 提前计算状态标志，避免重复检查
  - 只在必要时构建过滤数组
  - 只在没有锁定方向时才计算最小方向
  - 使用`requestAnimationFrame`异步执行锁定检查，不阻塞数据更新流程
- **已完成方向排除**：使用标记数组方式，确保已完成的方向完全排除在锁定逻辑之外

### 🐛 Bug修复

#### 锁定和测距相关
- **修复锁定后绿色高亮残留**：锁定后立即清除所有绿色高亮，确保只显示蓝色高亮
- **修复锁定卡片数据更新延迟**：锁定方向的卡片数据更新改为异步处理，避免阻塞其他方向的数据更新
- **修复测距按钮需要点击两次**：锁定后直接绑定按钮点击事件，确保点击一次即可测距
- **修复测距期间数据刷新**：测距期间不更新对应方向的显示，保持"计算中..."状态直到完成

#### 高亮显示相关
- **修复绿色高亮不显示**：完成测距后，正确排除已完成方向，在剩余未完成方向中显示绿色实时高亮
- **修复高亮闪烁问题**：优化高亮更新逻辑，只在最近方向改变时才更新UI，减少闪烁
- **修复锁定方向高亮延迟**：锁定后立即应用蓝色高亮，使用`important`优先级确保不被覆盖

#### 数据流相关
- **修复minDir未定义错误**：将`minDir`和`minDist`的定义移到条件块外，确保在整个函数作用域内可访问
- **修复已完成方向重复锁定**：在计算最小方向和自动锁定检查时，正确排除已完成的方向

### 📝 代码改进

#### 代码结构优化
- **异步处理优化**：使用`requestAnimationFrame`进行异步处理，避免阻塞数据更新流程
- **状态管理优化**：统一状态管理逻辑，确保状态一致性
- **日志记录优化**：精简日志内容，提高日志可读性

#### 性能优化
- **减少DOM操作**：批量处理数据更新，减少不必要的DOM操作
- **优化数组构建**：只在必要时构建过滤数组，减少内存分配
- **优化条件判断**：提前计算状态标志，避免重复检查

### 📚 文档更新

- **README.md**：更新版本信息、功能描述和架构说明
- **数据流程说明.md**：更新数据处理流程，反映最新的数据流和功能实现
- **CHANGELOG.md**：新增更新日志文件，记录所有功能更新和bug修复

---

## [v1.0.5] - 2025-12

### ✨ 初始版本

#### 核心功能
- **8方向ToF传感器**：通过TCA9548A多路复用器管理8个VL53L1X传感器
- **BLE原生通信**：ESP32-C3直接通过BLE Notify发送传感器数据
- **WebSocket Bridge**：Electron主进程创建WebSocket服务器作为数据中转
- **Web Bluetooth API**：浏览器直接连接BLE设备，无需串口通信
- **实时数据可视化**：23字节二进制数据包，每300ms更新一次

#### 基础功能
- **传感器数据采集**：8方向距离数据实时采集和显示
- **实时高亮**：绿色高亮显示最近距离方向
- **手动测距**：锁定方向后手动触发测距，收集3次数据计算平均值
- **状态管理**：锁定状态、完成状态管理
- **模拟功能**：模拟传感器数据和锁定功能（用于测试）

---

## 需求文档对应关系

### P0: 自动锁定功能 ✅ 已完成
- ✅ 开始实验按钮
- ✅ 实验状态管理
- ✅ 自动锁定逻辑
- ✅ 实验状态显示

### P1: 锁定后测距功能 ✅ 已完成
- ✅ 测距按钮显示
- ✅ 测距数据收集
- ✅ 测距结果处理
- ✅ 测距完成状态管理

### P2: AutoRun功能 ✅ 已完成
- ✅ AutoRun开关重命名
- ✅ 自动化流程实现
- ✅ 智能方向选择

### 已发现的问题 ✅ 已修复
- ✅ 模拟按钮禁用状态UI更新问题（已通过功能禁用保护解决）
- ✅ 锁定后绿色高亮残留问题
- ✅ 锁定卡片数据更新延迟问题
- ✅ 测距按钮需要点击两次问题
- ✅ 测距期间数据刷新问题
- ✅ 绿色高亮不显示问题
- ✅ 高亮闪烁问题
- ✅ 锁定方向高亮延迟问题
- ✅ minDir未定义错误
- ✅ 已完成方向重复锁定问题

---

**最后更新**: 2025年1月


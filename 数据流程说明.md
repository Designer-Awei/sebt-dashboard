# SEBT æ•°æ®æµç¨‹è¯¦è§£

## ğŸ“Š æ•°æ®æµç¨‹å›¾

```
ESP32-C3 (ç¡¬ä»¶ç«¯)
    â†“ [23å­—èŠ‚äºŒè¿›åˆ¶æ•°æ®åŒ…]
BLE Notify (NimBLE-Arduino)
    â†“ [BLEæ— çº¿é€šä¿¡]
æµè§ˆå™¨ Web Bluetooth API
    â†“ [WebSocketå®¢æˆ·ç«¯]
Electron WebSocketæœåŠ¡å™¨ (ç«¯å£3000)
    â†“ [IPCäº‹ä»¶: bluetooth-data]
app.js (æ¸²æŸ“è¿›ç¨‹/å‰ç«¯)
    â†“ [DOMæ›´æ–°]
ç”¨æˆ·ç•Œé¢ (8æ–¹å‘ä¼ æ„Ÿå™¨ç½‘æ ¼)
```

---

## 1ï¸âƒ£ ç¡¬ä»¶ç«¯å‘é€çš„æ•°æ®æ ¼å¼

### æ•°æ®åŒ…ç»“æ„ï¼ˆ23å­—èŠ‚äºŒè¿›åˆ¶ï¼‰

```cpp
// ä½ç½®  å¤§å°    å†…å®¹              è¯´æ˜
// 0-3   4å­—èŠ‚   æ—¶é—´æˆ³            millis()çš„å€¼ï¼Œå°ç«¯åº
// 4     1å­—èŠ‚   æœ€å°æ–¹å‘ç´¢å¼•       0-7è¡¨ç¤ºæ–¹å‘ï¼Œ255è¡¨ç¤ºæ— æ•ˆ
// 5-6   2å­—èŠ‚   æœ€å°è·ç¦»           uint16_tï¼Œå°ç«¯åºï¼Œå•ä½mm
// 7-22  16å­—èŠ‚  8æ–¹å‘è·ç¦»æ•°ç»„      æ¯ä¸ªæ–¹å‘2å­—èŠ‚ï¼Œå…±8ä¸ªæ–¹å‘
```

### BLEé€šä¿¡ç‰¹æ€§
- **åè®®**: BLE GATT Notify
- **Service UUID**: `0000aaaa-0000-1000-8000-00805f9b34fb`
- **Characteristic UUID**: `0000bbbb-0000-1000-8000-00805f9b34fb`
- **å‘é€é—´éš”**: 300msï¼ˆæœ‰å®¢æˆ·ç«¯è¿æ¥æ—¶ï¼‰
- **æ•°æ®å¯é æ€§**: ç¡¬ä»¶åªåœ¨BLEå®¢æˆ·ç«¯è¿æ¥æ—¶å‘é€æ•°æ®

### å®é™…æ•°æ®ç¤ºä¾‹

å‡è®¾å½“å‰çŠ¶æ€ï¼š
- æ—¶é—´æˆ³ï¼š`12345` (0x00003039)
- æœ€å°æ–¹å‘ï¼š`3` (Frontæ–¹å‘)
- æœ€å°è·ç¦»ï¼š`150mm` (0x0096)
- 8æ–¹å‘è·ç¦»ï¼š`[500, 600, 400, 150, 800, 700, 450, 550]`

**äºŒè¿›åˆ¶æ•°æ®åŒ…ï¼ˆåå…­è¿›åˆ¶ï¼‰ï¼š**
```
39 30 00 00    // æ—¶é—´æˆ³: 12345 (å°ç«¯åº)
03              // æœ€å°æ–¹å‘: 3 (Front)
96 00           // æœ€å°è·ç¦»: 150mm (å°ç«¯åº)
F4 01           // æ–¹å‘0: 500mm
58 02           // æ–¹å‘1: 600mm
90 01           // æ–¹å‘2: 400mm
96 00           // æ–¹å‘3: 150mm (æœ€å°è·ç¦»)
20 03           // æ–¹å‘4: 800mm
BC 02           // æ–¹å‘5: 700mm
C2 01           // æ–¹å‘6: 450mm
2E 02           // æ–¹å‘7: 550mm
```

**å®Œæ•´23å­—èŠ‚ï¼š**
```
39 30 00 00 03 96 00 F4 01 58 02 90 01 96 00 20 03 BC 02 C2 01 2E 02
```

### æ–¹å‘æ˜ å°„

```cpp
const char* DIR_NAMES[8] = {
  "Left",         // 0 â†’ L
  "BackLeft",    // 1 â†’ BL
  "FrontLeft",   // 2 â†’ FL
  "Front",        // 3 â†’ F
  "Back",         // 4 â†’ B
  "BackRight",   // 5 â†’ BR
  "FrontRight",  // 6 â†’ FR
  "Right"         // 7 â†’ R
};
```

### å‘é€é¢‘ç‡

- **å‘é€é—´éš”**ï¼šæ¯300mså‘é€ä¸€æ¬¡
- **æ•°æ®åŒ…å¤§å°**ï¼šå›ºå®š23å­—èŠ‚
- **é€šä¿¡åè®®**ï¼šBLE GATT Notify
- **è¿æ¥è¦æ±‚**ï¼šåªæœ‰åœ¨BLEå®¢æˆ·ç«¯è¿æ¥æ—¶æ‰å‘é€æ•°æ®

---

## 2ï¸âƒ£ è½¯ä»¶ç«¯æ¥æ”¶å’Œå¤„ç†

### WebSocket Bridge æ¶æ„

æ–°çš„æ¶æ„é‡‡ç”¨äº†WebSocket Bridgeè®¾è®¡ï¼Œå°†BLEé€šä¿¡ä¸Electronåº”ç”¨è§£è€¦ï¼š

```
ESP32-C3 â†’ BLE Notify â†’ æµè§ˆå™¨Web Bluetooth API â†’ WebSocket â†’ Electron â†’ UI
```

#### æ­¥éª¤1ï¼šBLEè®¾å¤‡è¿æ¥ï¼ˆæµè§ˆå™¨ç«¯ï¼‰

```javascript
// public/ble-driver.html
await navigator.bluetooth.requestDevice({
  filters: [{ services: [SERVICE_UUID] }]
});

const server = await device.gatt.connect();
const service = await server.getPrimaryService(SERVICE_UUID);
const characteristic = await service.getCharacteristic(CHARACTERISTIC_UUID);

// å¯ç”¨é€šçŸ¥æ¥æ”¶æ•°æ®
await characteristic.startNotifications();
characteristic.addEventListener('characteristicvaluechanged', handleData);
```

#### æ­¥éª¤2ï¼šWebSocketæ•°æ®è½¬å‘

```javascript
// æ¥æ”¶BLEæ•°æ®å¹¶é€šè¿‡WebSocketè½¬å‘
function handleCharacteristicValueChanged(event) {
  const data = event.target.value;
  const dataView = new DataView(data.buffer);

  // è§£æ23å­—èŠ‚æ•°æ®åŒ…
  const sensorData = {
    type: 'sensor_data',
    timestamp: dataView.getUint32(0, true),
    minDirection: dataView.getUint8(4),
    minDistance: dataView.getUint16(5, true),
    distances: Array.from({length: 8}, (_, i) =>
      dataView.getUint16(7 + i * 2, true))
  };

  // é€šè¿‡WebSocketå‘é€åˆ°Electron
  sendToElectron(sensorData);
}
```

#### æ­¥éª¤3ï¼šElectron WebSocketæœåŠ¡å™¨

```javascript
// main.js - WebSocketæœåŠ¡å™¨
wss.on('connection', (ws) => {
  ws.on('message', (message) => {
    const data = JSON.parse(message.toString());

    // è½¬å‘åˆ°æ¸²æŸ“è¿›ç¨‹
    if (mainWindow && !mainWindow.isDestroyed()) {
      mainWindow.webContents.send('bluetooth-data', data);
    }
  });
});
```

#### æ­¥éª¤4ï¼šBLEç®¡ç†å™¨æ•°æ®å¤„ç†

```javascript
// ble-manager.js - æ¥æ”¶WebSocketæ•°æ®
handleWebSocketData(data) {
  if (data.type === 'sensor_data') {
    const sensorData = this.validateSensorData(data);
    if (sensorData) {
      this.processSensorData(sensorData);
    }
  }
}

// æ•°æ®éªŒè¯ï¼ˆæµè§ˆå™¨å·²è§£æï¼Œç›´æ¥éªŒè¯JSONæ•°æ®ï¼‰
validateSensorData(data) {
  const isValid = data.minDistance >= 0 && data.minDistance <= 2000 &&
                  data.timestamp > 0 && data.minDirection >= -1 &&
                  data.minDirection < 8 && Array.isArray(data.distances) &&
                  data.distances.length === 8;

  return isValid ? data : null;
}
```

#### æ­¥éª¤5ï¼šè½¬æ¢ä¸ºå‰ç«¯æ ¼å¼

```javascript
// ble-manager.js - å‘é€ä¼ æ„Ÿå™¨æ•°æ®åˆ°å‰ç«¯
sendSensorData(sensorData) {
  // è½¬æ¢ä¸ºå‰ç«¯éœ€è¦çš„æ ¼å¼
  const distances = sensorData.distances.map((dist, index) => [index, dist]);

  const payload = {
    source: 'host',
    name: 'SEBT-Host-001',
    address: 'COM9',
    timestamp: sensorData.timestamp,        // 12345
    distances,                                // [[0,500], [1,600], ...]
    minDir: sensorData.minDirection,         // 3
    minDist: sensorData.minDistance,         // 150
    currentMinDirection: sensorData.minDirection,
    currentMinDistance: sensorData.minDistance,
    lockedDirection: -1,
    pressure: null
  };
  
  // é€šè¿‡IPCå‘é€åˆ°æ¸²æŸ“è¿›ç¨‹
  this.sendToRenderer('bluetooth-data-received', {
    type: 'scan_data',
    data: JSON.stringify(payload)
  });
}
```

**è½¬æ¢åçš„JSONæ•°æ®ç¤ºä¾‹ï¼š**
```json
{
  "source": "host",
  "name": "SEBT-Host-001",
  "address": "BLE_DEVICE_ID",
  "timestamp": 12345,
  "distances": [
    [0, 500],   // æ–¹å‘0: Left, 500mm
    [1, 600],   // æ–¹å‘1: BackLeft, 600mm
    [2, 400],   // æ–¹å‘2: FrontLeft, 400mm
    [3, 150],   // æ–¹å‘3: Front, 150mm â† æœ€å°è·ç¦»
    [4, 800],   // æ–¹å‘4: Back, 800mm
    [5, 700],   // æ–¹å‘5: BackRight, 700mm
    [6, 450],   // æ–¹å‘6: FrontRight, 450mm
    [7, 550]    // æ–¹å‘7: Right, 550mm
  ],
  "minDir": 3,
  "minDist": 150,
  "currentMinDirection": 3,
  "currentMinDistance": 150,
  "lockedDirection": -1,
  "pressure": null
}
```

---

## 3ï¸âƒ£ å‰ç«¯å±•ç¤ºæµç¨‹

### app.js æ¥æ”¶å’Œå¤„ç†

#### æ­¥éª¤1ï¼šIPCäº‹ä»¶ç›‘å¬

```javascript
// app.js:setupIPCListeners()
ipcRenderer.on('bluetooth-data', (event, data) => {
  // data = { type: 'sensor_data', timestamp: 12345, ... }
  this.handleWebSocketData(data);
});
```

#### æ­¥éª¤2ï¼šå¤„ç†WebSocketæ•°æ®

```javascript
// app.js - å¤„ç†WebSocketæ•°æ®
handleWebSocketData(data) {
  if (data.type === 'sensor_data') {
    // ç›´æ¥ä½¿ç”¨å·²è§£æçš„æ•°æ®
    const sensorData = {
      timestamp: data.timestamp,
      minDirection: data.minDirection,
      minDistance: data.minDistance,
      distances: data.distances,
      source: 'bluetooth'
    };

    // å¤„ç†ä¼ æ„Ÿå™¨æ•°æ®
    this.processSensorData(sensorData);
  }
}

// å¤„ç†ä¼ æ„Ÿå™¨æ•°æ®
processSensorData(sensorData) {
  // éå†8ä¸ªæ–¹å‘çš„è·ç¦»æ•°æ®
  sensorData.distances.forEach((distance, direction) => {
    const displayData = {
      direction: direction,
      distance: distance,
      timestamp: sensorData.timestamp,
      source: 'bluetooth',
      type: 'realtime',
      isMinDistance: direction === sensorData.minDirection
    };

    // æ›´æ–°ä¼ æ„Ÿå™¨æ˜¾ç¤º
    this.updateSensorDisplay(displayData);
  });

  // æ›´æ–°æœ€å°è·ç¦»é«˜äº®
  this.updateMinDistanceHighlight(sensorData.minDirection);
}
```

#### æ­¥éª¤3ï¼šæ›´æ–°UIæ˜¾ç¤º

```javascript
// app.js - æ›´æ–°ä¼ æ„Ÿå™¨æ˜¾ç¤º
updateSensorDisplay(sensorData) {
  const gridElement = this.gridElements.get(sensorData.direction);
  if (!gridElement) return;

  const distanceElement = gridElement.querySelector('.distance-display');

  // æ›´æ–°è·ç¦»æ–‡æœ¬
  distanceElement.textContent = sensorData.distance > 0
    ? `${sensorData.distance} mm`  // ä¾‹å¦‚: "150 mm"
    : '--- mm';

  // æ›´æ–°æ ·å¼
  if (sensorData.isMinDistance) {
    // æœ€å°è·ç¦»æ–¹å‘ï¼šæ©™è‰²é«˜äº®
    gridElement.classList.add('min-distance');
    distanceElement.style.color = '#f59e0b';
  } else {
    // æ™®é€šæ–¹å‘ï¼šè“è‰²æ˜¾ç¤º
    gridElement.classList.remove('min-distance');
    distanceElement.style.color = '#3b82f6';
  }
}
```

#### æ­¥éª¤4ï¼šé«˜äº®æœ€å°è·ç¦»æ–¹å‘

```javascript
// app.js - æ›´æ–°æœ€å°è·ç¦»é«˜äº®
updateMinDistanceHighlight(minDirection) {
  // æ¸…é™¤æ‰€æœ‰é«˜äº®
  this.gridElements.forEach((element) => {
    element.classList.remove('min-distance');
  });
  
  // æ‰¾åˆ°æœ€å°è·ç¦»çš„ä¼ æ„Ÿå™¨
  let minDistance = Infinity;
  let minChannel = -1;
  
  this.sensorData.forEach((data, channel) => {
    if (data.distance > 0 && data.distance < minDistance) {
      minDistance = data.distance;
      minChannel = channel;
    }
  });
  
  // é«˜äº®æœ€å°è·ç¦»æ–¹å‘
  if (minChannel >= 0) {
    const minElement = this.gridElements.get(minChannel);
    minElement.classList.add('min-distance');
  }
}
```

---

## 4ï¸âƒ£ å‰ç«¯UIå¸ƒå±€

### 8æ–¹å‘ä¼ æ„Ÿå™¨ç½‘æ ¼

```
        [FL] FrontLeft
            â†‘
[L] Left â† [F] Front â†’ [R] Right
            â†“
        [BL] BackLeft

    [B] Back
```

**HTMLç»“æ„ï¼š**
```html
<div class="sensor-grid">
  <!-- æ–¹å‘0: Left -->
  <div class="sensor-item" data-channel="0">
    <div class="direction-label">L</div>
    <div class="distance-display">500 mm</div>
  </div>
  
  <!-- æ–¹å‘1: BackLeft -->
  <div class="sensor-item" data-channel="1">
    <div class="direction-label">BL</div>
    <div class="distance-display">600 mm</div>
  </div>
  
  <!-- ... å…¶ä»–6ä¸ªæ–¹å‘ ... -->
  
  <!-- æ–¹å‘3: Front (æœ€å°è·ç¦») -->
  <div class="sensor-item min-distance" data-channel="3">
    <div class="direction-label">F</div>
    <div class="distance-display" style="color: #3b82f6;">150 mm</div>
  </div>
</div>
```

### è§†è§‰åé¦ˆ

1. **å®æ—¶æ•°æ®**ï¼šè“è‰²æ–‡å­— (`#3b82f6`)
2. **æœ€å°è·ç¦»æ–¹å‘**ï¼šæ·»åŠ  `min-distance` ç±»ï¼Œå¯èƒ½æœ‰è¾¹æ¡†é«˜äº®
3. **é”å®šçŠ¶æ€**ï¼šç»¿è‰²æ–‡å­— (`#10b981`)ï¼Œæ·»åŠ  `active` ç±»

---

## 5ï¸âƒ£ å®Œæ•´æ•°æ®æµç¤ºä¾‹

### åœºæ™¯ï¼šæ£€æµ‹åˆ°å‰æ–¹150mmå¤„æœ‰ç‰©ä½“

**1. ESP32-C3 è¯»å–ä¼ æ„Ÿå™¨ï¼š**
```cpp
// master-bt.ino:238-264
distances = [500, 600, 400, 150, 800, 700, 450, 550];
currentMinDir = 3;  // Front
currentMinDist = 150;
timestamp = 12345;
```

**2. æ„é€ å¹¶å‘é€23å­—èŠ‚æ•°æ®åŒ…ï¼š**
```cpp
// master-bt.ino:266-286
uint8_t dataPacket[23] = {
  0x39, 0x30, 0x00, 0x00,  // timestamp: 12345
  0x03,                     // minDir: 3
  0x96, 0x00,               // minDist: 150
  0xF4, 0x01,               // dist[0]: 500
  0x58, 0x02,               // dist[1]: 600
  // ... å…¶ä»–6ä¸ªæ–¹å‘
};
bluetoothSerial.write(dataPacket, 23);
```

**3. bt-manager.js æ¥æ”¶å¹¶è§£æï¼š**
```javascript
// æ¥æ”¶Buffer: <Buffer 39 30 00 00 03 96 00 F4 01 ...>
const sensorData = {
  timestamp: 12345,
  minDirection: 3,
  minDistance: 150,
  distances: [500, 600, 400, 150, 800, 700, 450, 550]
};
```

**4. è½¬æ¢ä¸ºJSONå¹¶å‘é€åˆ°å‰ç«¯ï¼š**
```javascript
// IPCäº‹ä»¶: 'bluetooth-data-received'
{
  type: 'scan_data',
  data: '{"timestamp":12345,"distances":[[0,500],[1,600],...],"minDir":3,"minDist":150}'
}
```

**5. app.js æ›´æ–°UIï¼š**
```javascript
// æ›´æ–°8ä¸ªæ–¹å‘çš„æ˜¾ç¤º
æ–¹å‘0 (Left):     "500 mm" (è“è‰²)
æ–¹å‘1 (BackLeft): "600 mm" (è“è‰²)
æ–¹å‘2 (FrontLeft): "400 mm" (è“è‰²)
æ–¹å‘3 (Front):    "150 mm" (è“è‰² + min-distanceé«˜äº®) â† æœ€å°è·ç¦»
æ–¹å‘4 (Back):     "800 mm" (è“è‰²)
æ–¹å‘5 (BackRight): "700 mm" (è“è‰²)
æ–¹å‘6 (FrontRight): "450 mm" (è“è‰²)
æ–¹å‘7 (Right):    "550 mm" (è“è‰²)
```

---

## ğŸ“ å…³é”®è¦ç‚¹æ€»ç»“

1. **é€šä¿¡æ¶æ„**ï¼šESP32-C3 BLE â†’ æµè§ˆå™¨Web Bluetooth API â†’ WebSocket â†’ Electron â†’ UI
2. **æ•°æ®æ ¼å¼**ï¼š23å­—èŠ‚å›ºå®šé•¿åº¦äºŒè¿›åˆ¶æ•°æ®åŒ…ï¼Œé€šè¿‡BLE Notifyå‘é€
3. **å­—èŠ‚åº**ï¼šæ‰€æœ‰å¤šå­—èŠ‚æ•°æ®ä½¿ç”¨å°ç«¯åºï¼ˆLittle Endianï¼‰
4. **å‘é€é¢‘ç‡**ï¼šæ¯300mså‘é€ä¸€æ¬¡ï¼ˆä»…åœ¨BLEå®¢æˆ·ç«¯è¿æ¥æ—¶ï¼‰
5. **æ–¹å‘æ˜ å°„**ï¼š0-7å¯¹åº”8ä¸ªæ–¹å‘ï¼Œ255è¡¨ç¤ºæ— æ•ˆ
6. **æ•°æ®è§£æ**ï¼šæµè§ˆå™¨ç«¯è§£æäºŒè¿›åˆ¶æ•°æ®ï¼Œè½¬æ¢ä¸ºJSONæ ¼å¼
7. **å®æ—¶æ›´æ–°**ï¼šWebSocketå®æ—¶è½¬å‘ï¼Œå‰ç«¯ç«‹å³æ›´æ–°8æ–¹å‘æ˜¾ç¤º

---

## ğŸ” è°ƒè¯•æŠ€å·§

### æŸ¥çœ‹BLEè®¾å¤‡è¿æ¥

åœ¨æµè§ˆå™¨æ§åˆ¶å°æŸ¥çœ‹ï¼š
```javascript
// æ£€æŸ¥BLEæ”¯æŒ
navigator.bluetooth.getAvailability()

// æŸ¥çœ‹å·²è¿æ¥è®¾å¤‡
navigator.bluetooth.getDevices()
```

### æŸ¥çœ‹WebSocketé€šä¿¡

åœ¨æµè§ˆå™¨Networkæ ‡ç­¾é¡µæŸ¥çœ‹WebSocketè¿æ¥ï¼Œæˆ–åœ¨æ§åˆ¶å°æ·»åŠ ï¼š
```javascript
// WebSocketæ¶ˆæ¯ç›‘å¬
ws.addEventListener('message', (event) => {
  console.log('WebSocketæ”¶åˆ°:', JSON.parse(event.data));
});
```

### æŸ¥çœ‹æ•°æ®è§£æè¿‡ç¨‹

åœ¨ `public/ble-driver.html` ä¸­ `handleCharacteristicValueChanged` å‡½æ•°å†…æ·»åŠ ï¼š
```javascript
console.log('BLEåŸå§‹æ•°æ®:', Array.from(new Uint8Array(value.buffer)));
console.log('è§£æåæ•°æ®:', sensorData);
```

### æŸ¥çœ‹Electronç«¯æ¥æ”¶

åœ¨ `main.js` WebSocketæ¶ˆæ¯å¤„ç†ä¸­æ·»åŠ ï¼š
```javascript
console.log('Electronæ”¶åˆ°WebSocketæ•°æ®:', data);
```

### æŸ¥çœ‹å‰ç«¯å¤„ç†

åœ¨ `app.js` `handleWebSocketData` ä¸­æ·»åŠ ï¼š
```javascript
console.log('å‰ç«¯å¤„ç†ä¼ æ„Ÿå™¨æ•°æ®:', sensorData);
```


# SEBT æ•°æ®æµç¨‹è¯¦è§£

## ğŸ“Š æ•°æ®æµç¨‹å›¾

```
ESP32-C3 (ç¡¬ä»¶ç«¯)
    â†“ [23å­—èŠ‚äºŒè¿›åˆ¶æ•°æ®åŒ…]
HC-05 è“ç‰™æ¨¡å—
    â†“ [ä¸²å£é€šä¿¡ 9600æ³¢ç‰¹ç‡]
Windows è“ç‰™ä¸²å£ (COM9)
    â†“ [Node.js serialportåº“]
bt-manager.js (ä¸»è¿›ç¨‹)
    â†“ [IPCäº‹ä»¶: bluetooth-data-received]
app.js (æ¸²æŸ“è¿›ç¨‹/å‰ç«¯)
    â†“ [DOMæ›´æ–°]
ç”¨æˆ·ç•Œé¢ (8æ–¹å‘ä¼ æ„Ÿå™¨ç½‘æ ¼)
```

---

## 1ï¸âƒ£ ç¡¬ä»¶ç«¯å‘é€çš„æ•°æ®æ ¼å¼

### æ•°æ®åŒ…ç»“æ„ï¼ˆ23å­—èŠ‚äºŒè¿›åˆ¶ï¼‰

```cpp
// ä½ç½®  å¤§å°    å†…å®¹              è¯´æ˜
// 0-3   4å­—èŠ‚   æ—¶é—´æˆ³            millis()çš„å€¼ï¼Œå°ç«¯åº
// 4     1å­—èŠ‚   æœ€å°æ–¹å‘ç´¢å¼•       0-7è¡¨ç¤ºæ–¹å‘ï¼Œ255è¡¨ç¤ºæ— æ•ˆ
// 5-6   2å­—èŠ‚   æœ€å°è·ç¦»           uint16_tï¼Œå°ç«¯åºï¼Œå•ä½mm
// 7-22  16å­—èŠ‚  8æ–¹å‘è·ç¦»æ•°ç»„      æ¯ä¸ªæ–¹å‘2å­—èŠ‚ï¼Œå…±8ä¸ªæ–¹å‘
```

### å®é™…æ•°æ®ç¤ºä¾‹

å‡è®¾å½“å‰çŠ¶æ€ï¼š
- æ—¶é—´æˆ³ï¼š`12345` (0x00003039)
- æœ€å°æ–¹å‘ï¼š`3` (Frontæ–¹å‘)
- æœ€å°è·ç¦»ï¼š`150mm` (0x0096)
- 8æ–¹å‘è·ç¦»ï¼š`[500, 600, 400, 150, 800, 700, 450, 550]`

**äºŒè¿›åˆ¶æ•°æ®åŒ…ï¼ˆåå…­è¿›åˆ¶ï¼‰ï¼š**
```
39 30 00 00    // æ—¶é—´æˆ³: 12345 (å°ç«¯åº)
03              // æœ€å°æ–¹å‘: 3 (Front)
96 00           // æœ€å°è·ç¦»: 150mm (å°ç«¯åº)
F4 01           // æ–¹å‘0: 500mm
58 02           // æ–¹å‘1: 600mm
90 01           // æ–¹å‘2: 400mm
96 00           // æ–¹å‘3: 150mm (æœ€å°è·ç¦»)
20 03           // æ–¹å‘4: 800mm
BC 02           // æ–¹å‘5: 700mm
C2 01           // æ–¹å‘6: 450mm
2E 02           // æ–¹å‘7: 550mm
```

**å®Œæ•´23å­—èŠ‚ï¼š**
```
39 30 00 00 03 96 00 F4 01 58 02 90 01 96 00 20 03 BC 02 C2 01 2E 02
```

### æ–¹å‘æ˜ å°„

```cpp
const char* DIR_NAMES[8] = {
  "Left",         // 0 â†’ L
  "BackLeft",    // 1 â†’ BL
  "FrontLeft",   // 2 â†’ FL
  "Front",        // 3 â†’ F
  "Back",         // 4 â†’ B
  "BackRight",   // 5 â†’ BR
  "FrontRight",  // 6 â†’ FR
  "Right"         // 7 â†’ R
};
```

### å‘é€é¢‘ç‡

- **å‘é€é—´éš”**ï¼šæ¯300mså‘é€ä¸€æ¬¡
- **æ•°æ®åŒ…å¤§å°**ï¼šå›ºå®š23å­—èŠ‚
- **é€šä¿¡åè®®**ï¼šç»å…¸è“ç‰™SPPï¼ˆä¸²å£åè®®ï¼‰

---

## 2ï¸âƒ£ è½¯ä»¶ç«¯æ¥æ”¶å’Œå¤„ç†

### bt-manager.js æ¥æ”¶æµç¨‹

#### æ­¥éª¤1ï¼šä¸²å£æ•°æ®æ¥æ”¶

```javascript
// bt-manager.js:309
port.on('data', (data) => {
  // dataæ˜¯Bufferå¯¹è±¡ï¼Œå¯èƒ½åŒ…å«å¤šä¸ªæ•°æ®åŒ…æˆ–éƒ¨åˆ†æ•°æ®åŒ…
  this.dataBuffer = Buffer.concat([this.dataBuffer, data]);
  
  // å½“ç¼“å†²åŒºé•¿åº¦ >= 23å­—èŠ‚æ—¶ï¼Œå°è¯•è§£ææ•°æ®åŒ…
  if (this.dataBuffer.length >= DATA_PACKET_SIZE) {
    // æŸ¥æ‰¾å¹¶è§£æå®Œæ•´çš„æ•°æ®åŒ…...
  }
});
```

#### æ­¥éª¤2ï¼šæ•°æ®åŒ…å¯¹é½å’Œè§£æ

ç”±äºæ•°æ®å¯èƒ½ä¸æ˜¯ä»æ•°æ®åŒ…è¾¹ç•Œå¼€å§‹æ¥æ”¶ï¼Œéœ€è¦æ»‘åŠ¨çª—å£æŸ¥æ‰¾ï¼š

```javascript
// bt-manager.js:314-344
for (let start = 0; start <= this.dataBuffer.length - DATA_PACKET_SIZE; start++) {
  const packet = this.dataBuffer.slice(start, start + DATA_PACKET_SIZE);
  const sensorData = this.parseSensorData(packet);
  
  if (sensorData && sensorData.minDistance >= 0 && sensorData.minDistance <= 5000) {
    // æ‰¾åˆ°æœ‰æ•ˆæ•°æ®åŒ…ï¼Œç§»é™¤å·²å¤„ç†çš„æ•°æ®
    this.dataBuffer = this.dataBuffer.slice(start + DATA_PACKET_SIZE);
    // å‘é€åˆ°å‰ç«¯...
  }
}
```

#### æ­¥éª¤3ï¼šäºŒè¿›åˆ¶æ•°æ®è§£æ

```javascript
// bt-manager.js:58-91
parseSensorData(buffer) {
  let offset = 0;
  
  // è¯»å–æ—¶é—´æˆ³ (4å­—èŠ‚ï¼Œå°ç«¯åº)
  const timestamp = buffer.readUInt32LE(offset);
  offset += 4;
  
  // è¯»å–æœ€å°æ–¹å‘ (1å­—èŠ‚)
  const minDirectionRaw = buffer.readUInt8(offset);
  const minDirection = minDirectionRaw === 255 ? -1 : minDirectionRaw;
  offset += 1;
  
  // è¯»å–æœ€å°è·ç¦» (2å­—èŠ‚ï¼Œå°ç«¯åº)
  const minDistance = buffer.readUInt16LE(offset);
  offset += 2;
  
  // è¯»å–8æ–¹å‘è·ç¦» (æ¯ä¸ª2å­—èŠ‚ï¼Œå°ç«¯åº)
  const distances = [];
  for (let i = 0; i < 8; i++) {
    distances.push(buffer.readUInt16LE(offset));
    offset += 2;
  }
  
  return {
    timestamp,      // 12345
    minDirection,   // 3
    minDistance,    // 150
    distances       // [500, 600, 400, 150, 800, 700, 450, 550]
  };
}
```

#### æ­¥éª¤4ï¼šè½¬æ¢ä¸ºå‰ç«¯æ ¼å¼

```javascript
// bt-manager.js:466-509
sendSensorData(sensorData) {
  // è½¬æ¢ä¸ºä¸BLEæ ¼å¼å…¼å®¹çš„æ•°æ®æ ¼å¼
  const distances = sensorData.distances.map((dist, index) => [index, dist]);
  // distances = [[0, 500], [1, 600], [2, 400], [3, 150], ...]
  
  const payload = {
    source: 'host',
    name: 'SEBT-Host-001',
    address: 'COM9',
    timestamp: sensorData.timestamp,        // 12345
    distances,                                // [[0,500], [1,600], ...]
    minDir: sensorData.minDirection,         // 3
    minDist: sensorData.minDistance,         // 150
    currentMinDirection: sensorData.minDirection,
    currentMinDistance: sensorData.minDistance,
    lockedDirection: -1,
    pressure: null
  };
  
  // é€šè¿‡IPCå‘é€åˆ°æ¸²æŸ“è¿›ç¨‹
  this.sendToRenderer('bluetooth-data-received', {
    type: 'scan_data',
    data: JSON.stringify(payload)
  });
}
```

**è½¬æ¢åçš„JSONæ•°æ®ç¤ºä¾‹ï¼š**
```json
{
  "source": "host",
  "name": "SEBT-Host-001",
  "address": "COM9",
  "timestamp": 12345,
  "distances": [
    [0, 500],   // æ–¹å‘0: Left, 500mm
    [1, 600],   // æ–¹å‘1: BackLeft, 600mm
    [2, 400],   // æ–¹å‘2: FrontLeft, 400mm
    [3, 150],   // æ–¹å‘3: Front, 150mm â† æœ€å°è·ç¦»
    [4, 800],   // æ–¹å‘4: Back, 800mm
    [5, 700],   // æ–¹å‘5: BackRight, 700mm
    [6, 450],   // æ–¹å‘6: FrontRight, 450mm
    [7, 550]    // æ–¹å‘7: Right, 550mm
  ],
  "minDir": 3,
  "minDist": 150,
  "currentMinDirection": 3,
  "currentMinDistance": 150,
  "lockedDirection": -1,
  "pressure": null
}
```

---

## 3ï¸âƒ£ å‰ç«¯å±•ç¤ºæµç¨‹

### app.js æ¥æ”¶å’Œå¤„ç†

#### æ­¥éª¤1ï¼šIPCäº‹ä»¶ç›‘å¬

```javascript
// app.js:setupIPCListeners()
ipcRenderer.on('bluetooth-data-received', (event, data) => {
  // data = { type: 'scan_data', data: '{"timestamp":12345,...}' }
  this.handleBluetoothData(data);
});
```

#### æ­¥éª¤2ï¼šè§£æJSONæ•°æ®

```javascript
// app.js:1061-1088
handleBluetoothData(data) {
  const jsonData = JSON.parse(data.data);
  
  // éå†8ä¸ªæ–¹å‘çš„è·ç¦»æ•°æ®
  if (jsonData.distances && Array.isArray(jsonData.distances)) {
    jsonData.distances.forEach(([direction, distance]) => {
      // direction: 0-7 (æ–¹å‘ç´¢å¼•)
      // distance: è·ç¦»å€¼ (mm)
      
      const sensorData = {
        direction: direction,
        distance: distance,
        timestamp: jsonData.timestamp,
        source: 'bluetooth',
        type: 'realtime'
      };
      
      // æ›´æ–°ä¼ æ„Ÿå™¨æ˜¾ç¤º
      this.updateSensorDisplay(sensorData);
      
      // å¦‚æœæ˜¯æœ€å°è·ç¦»æ–¹å‘ï¼Œæ›´æ–°é«˜äº®
      if (direction === jsonData.minDir) {
        this.updateMinDistanceHighlight(direction);
      }
    });
  }
}
```

#### æ­¥éª¤3ï¼šæ›´æ–°UIæ˜¾ç¤º

```javascript
// app.js:881-902
updateSensorDisplay(channel, sensorData) {
  const gridElement = this.gridElements.get(channel);
  const distanceElement = gridElement.querySelector('.distance-display');
  
  // æ›´æ–°è·ç¦»æ–‡æœ¬
  distanceElement.textContent = sensorData.distance > 0
    ? `${sensorData.distance} mm`  // ä¾‹å¦‚: "150 mm"
    : '--- mm';
  
  // æ›´æ–°æ ·å¼
  if (sensorData.active) {
    // é”å®šçŠ¶æ€ï¼šç»¿è‰²é«˜äº®
    gridElement.classList.add('active');
    distanceElement.style.color = '#10b981';
  } else {
    // å®æ—¶æ•°æ®ï¼šè“è‰²æ˜¾ç¤º
    gridElement.classList.remove('active');
    distanceElement.style.color = '#3b82f6';
  }
}
```

#### æ­¥éª¤4ï¼šé«˜äº®æœ€å°è·ç¦»æ–¹å‘

```javascript
// app.js:844-876
updateMinDistanceHighlight() {
  // æ¸…é™¤æ‰€æœ‰é«˜äº®
  this.gridElements.forEach((element) => {
    element.classList.remove('min-distance');
  });
  
  // æ‰¾åˆ°æœ€å°è·ç¦»çš„ä¼ æ„Ÿå™¨
  let minDistance = Infinity;
  let minChannel = -1;
  
  this.sensorData.forEach((data, channel) => {
    if (data.distance > 0 && data.distance < minDistance) {
      minDistance = data.distance;
      minChannel = channel;
    }
  });
  
  // é«˜äº®æœ€å°è·ç¦»æ–¹å‘
  if (minChannel >= 0) {
    const minElement = this.gridElements.get(minChannel);
    minElement.classList.add('min-distance');
  }
}
```

---

## 4ï¸âƒ£ å‰ç«¯UIå¸ƒå±€

### 8æ–¹å‘ä¼ æ„Ÿå™¨ç½‘æ ¼

```
        [FL] FrontLeft
            â†‘
[L] Left â† [F] Front â†’ [R] Right
            â†“
        [BL] BackLeft

    [B] Back
```

**HTMLç»“æ„ï¼š**
```html
<div class="sensor-grid">
  <!-- æ–¹å‘0: Left -->
  <div class="sensor-item" data-channel="0">
    <div class="direction-label">L</div>
    <div class="distance-display">500 mm</div>
  </div>
  
  <!-- æ–¹å‘1: BackLeft -->
  <div class="sensor-item" data-channel="1">
    <div class="direction-label">BL</div>
    <div class="distance-display">600 mm</div>
  </div>
  
  <!-- ... å…¶ä»–6ä¸ªæ–¹å‘ ... -->
  
  <!-- æ–¹å‘3: Front (æœ€å°è·ç¦») -->
  <div class="sensor-item min-distance" data-channel="3">
    <div class="direction-label">F</div>
    <div class="distance-display" style="color: #3b82f6;">150 mm</div>
  </div>
</div>
```

### è§†è§‰åé¦ˆ

1. **å®æ—¶æ•°æ®**ï¼šè“è‰²æ–‡å­— (`#3b82f6`)
2. **æœ€å°è·ç¦»æ–¹å‘**ï¼šæ·»åŠ  `min-distance` ç±»ï¼Œå¯èƒ½æœ‰è¾¹æ¡†é«˜äº®
3. **é”å®šçŠ¶æ€**ï¼šç»¿è‰²æ–‡å­— (`#10b981`)ï¼Œæ·»åŠ  `active` ç±»

---

## 5ï¸âƒ£ å®Œæ•´æ•°æ®æµç¤ºä¾‹

### åœºæ™¯ï¼šæ£€æµ‹åˆ°å‰æ–¹150mmå¤„æœ‰ç‰©ä½“

**1. ESP32-C3 è¯»å–ä¼ æ„Ÿå™¨ï¼š**
```cpp
// master-bt.ino:238-264
distances = [500, 600, 400, 150, 800, 700, 450, 550];
currentMinDir = 3;  // Front
currentMinDist = 150;
timestamp = 12345;
```

**2. æ„é€ å¹¶å‘é€23å­—èŠ‚æ•°æ®åŒ…ï¼š**
```cpp
// master-bt.ino:266-286
uint8_t dataPacket[23] = {
  0x39, 0x30, 0x00, 0x00,  // timestamp: 12345
  0x03,                     // minDir: 3
  0x96, 0x00,               // minDist: 150
  0xF4, 0x01,               // dist[0]: 500
  0x58, 0x02,               // dist[1]: 600
  // ... å…¶ä»–6ä¸ªæ–¹å‘
};
bluetoothSerial.write(dataPacket, 23);
```

**3. bt-manager.js æ¥æ”¶å¹¶è§£æï¼š**
```javascript
// æ¥æ”¶Buffer: <Buffer 39 30 00 00 03 96 00 F4 01 ...>
const sensorData = {
  timestamp: 12345,
  minDirection: 3,
  minDistance: 150,
  distances: [500, 600, 400, 150, 800, 700, 450, 550]
};
```

**4. è½¬æ¢ä¸ºJSONå¹¶å‘é€åˆ°å‰ç«¯ï¼š**
```javascript
// IPCäº‹ä»¶: 'bluetooth-data-received'
{
  type: 'scan_data',
  data: '{"timestamp":12345,"distances":[[0,500],[1,600],...],"minDir":3,"minDist":150}'
}
```

**5. app.js æ›´æ–°UIï¼š**
```javascript
// æ›´æ–°8ä¸ªæ–¹å‘çš„æ˜¾ç¤º
æ–¹å‘0 (Left):     "500 mm" (è“è‰²)
æ–¹å‘1 (BackLeft): "600 mm" (è“è‰²)
æ–¹å‘2 (FrontLeft): "400 mm" (è“è‰²)
æ–¹å‘3 (Front):    "150 mm" (è“è‰² + min-distanceé«˜äº®) â† æœ€å°è·ç¦»
æ–¹å‘4 (Back):     "800 mm" (è“è‰²)
æ–¹å‘5 (BackRight): "700 mm" (è“è‰²)
æ–¹å‘6 (FrontRight): "450 mm" (è“è‰²)
æ–¹å‘7 (Right):    "550 mm" (è“è‰²)
```

---

## ğŸ“ å…³é”®è¦ç‚¹æ€»ç»“

1. **æ•°æ®æ ¼å¼**ï¼š23å­—èŠ‚å›ºå®šé•¿åº¦äºŒè¿›åˆ¶æ•°æ®åŒ…
2. **å­—èŠ‚åº**ï¼šæ‰€æœ‰å¤šå­—èŠ‚æ•°æ®ä½¿ç”¨å°ç«¯åºï¼ˆLittle Endianï¼‰
3. **å‘é€é¢‘ç‡**ï¼šæ¯300mså‘é€ä¸€æ¬¡
4. **æ•°æ®å¯¹é½**ï¼šè½¯ä»¶ç«¯ä½¿ç”¨æ»‘åŠ¨çª—å£å¤„ç†æ•°æ®åŒ…è¾¹ç•Œå¯¹é½
5. **æ–¹å‘æ˜ å°„**ï¼š0-7å¯¹åº”8ä¸ªæ–¹å‘ï¼Œ255è¡¨ç¤ºæ— æ•ˆ
6. **å‰ç«¯å…¼å®¹**ï¼šè½¬æ¢ä¸ºJSONæ ¼å¼ï¼Œå…¼å®¹åŸæœ‰çš„BLEæ•°æ®æ ¼å¼
7. **å®æ—¶æ›´æ–°**ï¼šå‰ç«¯æ¯300msæ›´æ–°ä¸€æ¬¡8æ–¹å‘çš„è·ç¦»æ˜¾ç¤º

---

## ğŸ” è°ƒè¯•æŠ€å·§

### æŸ¥çœ‹åŸå§‹äºŒè¿›åˆ¶æ•°æ®

åœ¨ `bt-manager.js` ä¸­æ·»åŠ ï¼š
```javascript
console.log('åŸå§‹æ•°æ®åŒ…:', data.toString('hex'));
// è¾“å‡º: 39300000039600f4015802...
```

### æŸ¥çœ‹è§£æåçš„æ•°æ®

åœ¨ `parseSensorData` ä¸­æ·»åŠ ï¼š
```javascript
console.log('è§£æç»“æœ:', {
  timestamp,
  minDirection: DIR_NAMES[minDirection],
  minDistance,
  distances: distances.map((d, i) => `${DIR_NAMES[i]}:${d}mm`)
});
```

### æŸ¥çœ‹å‰ç«¯æ¥æ”¶çš„æ•°æ®

åœ¨ `handleBluetoothData` ä¸­æ·»åŠ ï¼š
```javascript
console.log('å‰ç«¯æ¥æ”¶:', jsonData);
```


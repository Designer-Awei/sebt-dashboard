# SEBT 平衡测试系统更新日志

## [v1.0.8] - 2025-01（计划中）

### 📋 后续功能规划

#### 从机数据并联调功能（P4）
- **从机硬件代码更新**：修改从机BLE UUID格式，与主机保持一致
  - Service UUID: `0000cccc-0000-1000-8000-00805f9b34fb`
  - Characteristic UUID: `0000dddd-0000-1000-8000-00805f9b34fb`
  - 设备名称: `SEBT-Slave-001`
- **BLE驱动页面集成**（待实现）：将主机和从机BLE驱动集成到统一页面
  - 当前状态：主机和从机使用独立的BLE驱动页面
  - 目标：在同一页面内同时连接主机和从机设备
  - UI设计：页面分为主机连接区域和从机连接区域，独立显示连接状态和数据
  - 功能：支持同时连接两个设备，独立处理连接、断开和数据接收
- **主页面压力值显示**（待实现）：在中心卡片显示从机压力值
  - 位置：主页面3x3网格的中心卡片（`.grid-item.center`）内
  - 显示位置：在"平衡测试系统"文字的下方
  - 显示格式：`pressure：xxxx`（xxxx为实时压力值）
  - 数据来源：通过WebSocket接收从机压力数据后实时刷新
  - 实现：修改`createLogoContent()`函数添加压力值显示元素，添加`updatePressureDisplay()`函数更新显示
- **测距按钮控制逻辑**：从机负责控制"测距按钮"是否可用
  - 需要同时满足从机稳定阈值参数和稳定时长参数
  - AutoRun模式下，满足锁定条件后再满足从机条件后自动测距
- **数据流程集成**：在BLE驱动和数据流程中加入从机数据并联调

---

## [v1.0.7] - 2025-01

### 🎨 UI优化

#### 界面样式优化
- **结束测试按钮**：将灰色背景改为红色背景（`#ef4444`），更醒目地提示用户操作
- **模态窗标题**：将"实验记录"改为"SEBT 数据记录"，更符合产品命名规范
- **按钮布局优化**：
  - "重新测试"和"导出数据"按钮居中显示
  - 按钮间距调整为100px，视觉效果更佳
  - "重新测试"按钮：蓝色背景（`#3b82f6`）
  - "导出数据"按钮：绿色背景（`#10b981`）
  - 两个按钮都使用白色文字，对比度更高

#### 测试分数显示优化
- **保留2位小数**：测试分数显示格式从整数改为保留2位小数（例如：`12.34`）
- **一致性**：模态窗显示、CSV导出、文件名生成都使用2位小数格式

### 🔧 功能优化

#### 导出功能优化
- **自动重置状态**：导出成功后自动回到初始状态（类似点击"重新测试"按钮）
- **用户体验提升**：导出后无需手动点击"重新测试"，流程更顺畅

#### 日志优化
- **减少重复日志**：优化日志输出逻辑，只在值变化时输出详细日志
- **日志频率控制**：无更新时每10次输出一次状态检查日志
- **调试信息精简**：移除重复的`measurementResults`和`completedDirections`日志输出

---

## [v1.0.7] - 2025-01

### ✨ 新增功能

#### 实验记录和导出功能（P3）
- **按钮文本修改**：将"开始实验"改为"开始测试"，"停止实验"改为"结束测试"
- **实验记录模态窗**：结束测试时自动弹出实验记录模态窗
  - 基础信息输入板块：被测序号、性别、年龄、腿长（cm）
  - 主机/从机参数显示：锁定时长、稳定时长、压力阈值范围（只读）
  - 8方向读数表格：实时显示已完成测距方向的读数
  - 测试分数计算：自动计算并显示测试分数（实时更新）
- **CSV导出功能**：
  - 文件保存对话框，支持自定义保存路径
  - 文件名自动生成：`SEBT-序号-分数-时间（年月日）`格式
  - CSV格式：固定两行（表头+数据），包含所有实验数据
- **重新测试功能**：一键重置实验状态，清空已完成测距数据
- **误触恢复功能**：点击模态窗关闭按钮可恢复测试状态，继续测试

### 🔧 功能优化

#### 数据同步优化
- **实时数据更新**：模态窗显示时每500ms自动更新表格数据
- **数据源优先级**：直接使用`measurementResults`作为数据源（与`calculateTestScore()`保持一致）
- **数据一致性**：确保`measurementResults`和`sensorData`数据同步

### 🐛 Bug修复

#### 数据更新问题修复 ✅
- **问题描述**：实验记录模态窗内已完成测距方向的数值无法即时更新显示，所有读数都显示为0
- **根本原因**：
  - `updateMeasurementTable()`函数使用了复杂的数据读取逻辑，导致数据读取失败
  - 主页面的频繁DOM更新（每300ms）阻塞了模态窗的定时器更新
- **修复方案**：
  - 简化`updateMeasurementTable()`函数：直接使用`measurementResults`作为数据源（与`calculateTestScore()`保持一致）
  - 使用`requestAnimationFrame`优化更新：定时器更新和初始更新都使用`requestAnimationFrame`，避免被主页面DOM操作阻塞
  - 优化DOM更新性能：批量收集更新操作，只在值变化时才更新DOM，减少重排和重绘
  - 添加调试日志：输出已完成方向的读数，便于排查问题
- **修复效果**：
  - 模态窗表格现在能正确显示已完成测距方向的实时读数
  - 无论什么时候打开模态窗（测试一半时/测试完成后），都能立即显示当前已完成方向的读数
  - 解决了主页面刷新闪烁导致的模态窗更新阻塞问题

#### 移除完成通知弹窗 ✅
- **修改内容**：移除所有方向完成测距后的通知弹窗（`checkExperimentCompletion()`函数中的`alert`）
- **原因**：已有实验记录模态窗，不需要额外的通知弹窗
- **影响**：用户体验更流畅，不会被打断

---

## [v1.0.6] - 2025-12-22

### ✨ 新增功能

#### 自动锁定功能
- **开始实验按钮**：在主页面controls区域新增"开始实验"按钮
- **实验状态管理**：新增实验运行状态（`experimentRunning`），支持开始/停止实验
- **自动锁定逻辑**：当同一方向连续达到N次（可配置，默认10次）为最近距离时，自动锁定该方向
- **实验状态显示**：在main-content容器左上角添加实验状态显示组件，显示实验运行状态和时长（分:秒格式）
- **状态互斥**：锁定期间，绿色实时高亮暂停显示，避免视觉冲突

#### AutoRun功能
- **AutoRun开关**：将"开启/关闭锁定"滑块重命名为"AutoRun - 锁定&测距"
- **自动化流程**：开启AutoRun后，自动执行"锁定→测距→下一个方向"的完整循环
- **智能方向选择**：自动选择未完成测距方向中最近的方向进行锁定和测距
- **完全自动化**：无需手动点击测距按钮，系统自动完成所有方向的测试

### 🔧 功能优化

#### 锁定和测距流程优化
- **锁定状态管理**：确保同一时间只能存在一个锁定方向
- **锁定后即时反馈**：锁定后立即显示蓝色高亮，不再显示绿色高亮
- **测距按钮优化**：锁定后自动显示测距按钮，点击一次即可开始测距（无需先选择卡片）
- **测距数据收集**：使用第一手数据（`handleHostBroadcast`）进行测距数据收集，确保数据准确性
- **测距完成反馈**：测距完成后立即显示"计算中..."状态，直到最终读数固定

#### UI/UX优化
- **日志滚动方向**：事件日志改为从上到下刷新（新日志出现在旧日志下方），自动滚动到最新日志
- **日志精简**：精简日志内容，移除重复和琐碎信息
  - 锁定日志：只显示方向，不显示距离（`🔒 锁定方向: 后`）
  - 测距日志：统一为"测距完成"，不区分手动/自动（`📐 测距完成: 后 - 76mm`）
  - 移除"开始测距"、"手动测距"、"前端自动锁定"等冗余日志
- **按钮状态优化**：修复"开始实验"按钮切换为"停止实验"时的margin-top重复问题
- **高亮互斥**：确保绿色实时高亮和蓝色锁定高亮完全互斥，不会同时显示

#### 数据处理优化
- **数据有效性判断移除**：删除软件端对传入数据数值有效性的判断逻辑，直接使用真实的传入数据
- **数据更新流畅度**：优化从数据接收到锁定判断的处理链路，提高实时性
  - 提前计算状态标志，避免重复检查
  - 只在必要时构建过滤数组
  - 只在没有锁定方向时才计算最小方向
  - 使用`requestAnimationFrame`异步执行锁定检查，不阻塞数据更新流程
- **已完成方向排除**：使用标记数组方式，确保已完成的方向完全排除在锁定逻辑之外

### 🐛 Bug修复

#### 锁定和测距相关
- **修复锁定后绿色高亮残留**：锁定后立即清除所有绿色高亮，确保只显示蓝色高亮
- **修复锁定卡片数据更新延迟**：锁定方向的卡片数据更新改为异步处理，避免阻塞其他方向的数据更新
- **修复测距按钮需要点击两次**：锁定后直接绑定按钮点击事件，确保点击一次即可测距
- **修复测距期间数据刷新**：测距期间不更新对应方向的显示，保持"计算中..."状态直到完成

#### 高亮显示相关
- **修复绿色高亮不显示**：完成测距后，正确排除已完成方向，在剩余未完成方向中显示绿色实时高亮
- **修复高亮闪烁问题**：优化高亮更新逻辑，只在最近方向改变时才更新UI，减少闪烁
- **修复锁定方向高亮延迟**：锁定后立即应用蓝色高亮，使用`important`优先级确保不被覆盖

#### 数据流相关
- **修复minDir未定义错误**：将`minDir`和`minDist`的定义移到条件块外，确保在整个函数作用域内可访问
- **修复已完成方向重复锁定**：在计算最小方向和自动锁定检查时，正确排除已完成的方向

### 📝 代码改进

#### 代码结构优化
- **异步处理优化**：使用`requestAnimationFrame`进行异步处理，避免阻塞数据更新流程
- **状态管理优化**：统一状态管理逻辑，确保状态一致性
- **日志记录优化**：精简日志内容，提高日志可读性

#### 性能优化
- **减少DOM操作**：批量处理数据更新，减少不必要的DOM操作
- **优化数组构建**：只在必要时构建过滤数组，减少内存分配
- **优化条件判断**：提前计算状态标志，避免重复检查

### 📚 文档更新

- **README.md**：更新版本信息、功能描述和架构说明
- **数据流程说明.md**：更新数据处理流程，反映最新的数据流和功能实现
- **CHANGELOG.md**：新增更新日志文件，记录所有功能更新和bug修复

---

## [v1.0.5] - 2025-12

### ✨ 初始版本

#### 核心功能
- **8方向ToF传感器**：通过TCA9548A多路复用器管理8个VL53L1X传感器
- **BLE原生通信**：ESP32-C3直接通过BLE Notify发送传感器数据
- **WebSocket Bridge**：Electron主进程创建WebSocket服务器作为数据中转
- **Web Bluetooth API**：浏览器直接连接BLE设备，无需串口通信
- **实时数据可视化**：23字节二进制数据包，每300ms更新一次

#### 基础功能
- **传感器数据采集**：8方向距离数据实时采集和显示
- **实时高亮**：绿色高亮显示最近距离方向
- **手动测距**：锁定方向后手动触发测距，收集3次数据计算平均值
- **状态管理**：锁定状态、完成状态管理
- **模拟功能**：模拟传感器数据和锁定功能（用于测试）

---

## 需求文档对应关系

### P0: 自动锁定功能 ✅ 已完成
- ✅ 开始实验按钮
- ✅ 实验状态管理
- ✅ 自动锁定逻辑
- ✅ 实验状态显示

### P1: 锁定后测距功能 ✅ 已完成
- ✅ 测距按钮显示
- ✅ 测距数据收集
- ✅ 测距结果处理
- ✅ 测距完成状态管理

### P2: AutoRun功能 ✅ 已完成
- ✅ AutoRun开关重命名
- ✅ 自动化流程实现
- ✅ 智能方向选择

### 已发现的问题 ✅ 已修复
- ✅ 模拟按钮禁用状态UI更新问题（已通过功能禁用保护解决）
- ✅ 锁定后绿色高亮残留问题
- ✅ 锁定卡片数据更新延迟问题
- ✅ 测距按钮需要点击两次问题
- ✅ 测距期间数据刷新问题
- ✅ 绿色高亮不显示问题
- ✅ 高亮闪烁问题
- ✅ 锁定方向高亮延迟问题
- ✅ minDir未定义错误
- ✅ 已完成方向重复锁定问题
- ✅ 实验记录模态窗数据更新问题（v1.0.7）

---

**最后更新**: 2025年1月（v1.0.8）


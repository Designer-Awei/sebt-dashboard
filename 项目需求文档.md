# SEBT数据自动化处理功能需求文档

## 现有代码分析

### 已实现的代码功能
1. **基础架构**：
   - 8方向传感器数据处理（方位映射：L, BL, FL, F, B, BR, FR, R）
   - 传感器数据存储和管理（Map结构）
   - UI网格布局（3x3，中心为LOGO）

2. **锁定功能基础**：
   - 锁定方向集合 (`lockedDirections`) 和完成测距集合 (`completedDirections`)
   - 锁定状态管理（`lockDirection()`, `resetLockedDirections()`）
   - 蓝色高亮锁定卡片样式
   - 锁定时长参数设置（主机模态窗内滑块控制）

3. **手动测距功能**：
   - 测距按钮显示逻辑（只在锁定方向显示）
   - 手动测距流程（`performManualMeasurement()`）
   - 测距数据收集（最近3次取平均值）
   - 测距结果处理（`handleManualMeasurementResult()`）
   - 完成测距状态管理

4. **实时数据显示**：
   - 绿色高亮最近距离方向（`highlightClosestDirection()`）
   - 距离数据实时更新
   - 高亮互斥逻辑（蓝色锁定优先级高于绿色高亮）

5. **模拟功能**：
   - 模拟传感器数据生成
   - 模拟锁定功能
   - 设备连接状态管理

### 代码中的关键变量和常量
```javascript
// 自动锁定相关常量
this.HARDWARE_SEND_INTERVAL_MS = 300; // 硬件发送间隔
this.LOCK_REQUIRED_COUNT = 10; // 默认锁定连续次数
this.AUTO_LOCK_TIME_MS = this.LOCK_REQUIRED_COUNT * this.HARDWARE_SEND_INTERVAL_MS;

// 状态集合
this.lockedDirections = new Set(); // 已锁定方向
this.completedDirections = new Set(); // 已完成测距方向

// 自动锁定状态跟踪
this.currentMinDirection = -1;
this.minDirectionStartTime = 0;
this.minDirectionConsecutiveCount = 0;
```

### UI控件现状
- **controls区域**：包含"AutoRun"开关、"模拟数据"按钮、"模拟锁定"按钮、"重置状态"按钮、**✅ "开始实验"按钮**（待改为"开始测试"）
- **锁定参数设置**：主机模态窗内有锁定时长滑块（5-30次连续，默认10次）
- **卡片交互**：锁定方向显示手动测距按钮

### 已完成的功能
- **✅ P0 UI层面**：开始实验按钮已添加到controls区域
- **✅ P0 逻辑层面**：自动锁定功能已实现
- **✅ P1 功能**：锁定后测距功能已实现
- **✅ P2 UI层面**：开启/关闭锁定已重命名为"AutoRun"
- **✅ P2 逻辑层面**：AutoRun自动化流程已实现

### 已完成的功能（P3）
- **✅ P3 UI层面**：按钮文本修改（"开始实验"→"开始测试"，"停止实验"→"结束测试"）
- **✅ P3 UI层面**：实验记录模态窗创建（基础信息输入+表格+底部按钮）
- **✅ P3 逻辑层面**：实验记录数据收集和计算（8方向读数+测试分数）
- **✅ P3 逻辑层面**：CSV导出功能实现（文件保存对话框+文件名生成）
- **✅ P3 逻辑层面**：重新测试功能实现（重置状态、清空数据）
- **✅ P3 逻辑层面**：误触恢复功能实现（关闭按钮恢复测试状态）
- **✅ P3 逻辑层面**：实时数据更新机制（500ms定时器更新表格）
- **✅ P3 Bug修复**：实验记录模态窗数据更新问题已修复（v1.0.7）
- **✅ P3 UI优化**：按钮样式优化、模态窗标题修改、测试分数保留2位小数（v1.0.8）
- **✅ P3 功能优化**：导出后自动重置状态、日志优化（v1.0.8）

---

## 功能需求规划

### 功能优先级排序

#### P0: 自动锁定功能（核心功能）
**需求描述**：
- 在主页面controls容器内新增"开始实验"按钮
- 点击"开始实验"后，开始连续监测传感器数据
- 当同一方向连续达到N次（主机模态窗参数）为最近距离时，自动锁定该方向
- 锁定状态：卡片显示蓝色高亮，只能同时锁定一个方向
- 锁定期间，绿色实时高亮暂停显示（防止视觉冲突）

**实现方案**：
1. **UI层面**：
   - 在controls区域添加"开始实验"按钮
   - 按钮状态管理（开始实验/停止实验）
   - 实验状态指示器

2. **逻辑层面**：
   - 新增实验状态管理（`experimentRunning`）
   - 扩展现有自动锁定计数逻辑（`handleAutoLock()`）
   - 集成到传感器数据处理流程
   - 实验开始/结束状态管理

3. **数据流程**：
   ```
   开始实验 → 接收传感器数据 → 连续计数判断 → 达到阈值 → 自动锁定
   ```

#### P1: 锁定后测距功能（完善现有功能）
**需求描述**：
- 锁定方向卡片自动显示测距按钮
- 点击测距按钮后，记录测距按钮按下后最近3次传入的对应方向读数
- 计算平均值并取整，作为最终测距结果
- 更新卡片显示固定距离值
- 测距完成后回到待测状态，但该方向不再参与实时高亮计算

**实现方案**：
1. **修复现有bug**：
   - 检查测距数据收集逻辑是否正确
   - 验证测距结果显示和状态更新

2. **完善测距流程**：
   - 优化测距按钮显示时机
   - 改进测距状态反馈
   - 完善测距完成后的状态管理

#### P2: AutoRun功能（自动化升级）
**需求描述**：
- 将主页面"开启/关闭锁定"滑块按钮重命名为"AutoRun"
- AutoRun默认关闭状态
- 开启AutoRun后，在"开始实验"后自动执行锁定→测距→下一个方向的完整流程
- 无需手动点击测距按钮，直接自动完成所有方向的测试

**实现方案**：
1. **UI层面**：
   - 重命名"开启/关闭锁定"为"AutoRun"
   - 添加AutoRun状态指示

2. **逻辑层面**：
   - 新增AutoRun状态管理（`autoRunEnabled`）
   - 扩展锁定完成处理逻辑
   - 自动触发测距流程
   - 智能选择下一个待测方向

#### P3: 实验记录和导出功能（数据管理）
**需求描述**：
- **按钮文本修改**：将"开始实验"改为"开始测试"，"停止实验"改为"结束测试"
- **实验记录模态窗**：在"开始测试"状态下点击"结束测试"按钮时，弹出实验记录模态窗
- **基础信息输入板块**：包含以下字段
  - 被测序号（文本输入）
  - 被测性别（下拉选择：男/女）
  - 被测年龄（数字输入）
  - 被测腿长（数字输入，单位：cm）
  - 主机参数（锁定时长，只读显示，从前端读取`LOCK_REQUIRED_COUNT`）
  - 从机参数（稳定时长、压力阈值范围，只读显示，从前端读取`stableRequiredCount`、`pressureMinThreshold`、`pressureMaxThreshold`）
- **表格板块**：展示实验数据
  - 8方向读数：显示8个方向的测距结果（L, BL, FL, F, B, BR, FR, R）
  - 未完成测距的方向在表格中显示为0
  - 测试分数：计算公式 = `(8个方向的距离总和 / (8 × 腿长)) × 100`
    - 注意单位换算：传感器数据单位为mm，腿长输入单位为cm
    - 计算时需要将腿长从cm转换为mm：`腿长(mm) = 腿长(cm) × 10`
    - 最终公式：`测试分数 = (8个方向距离总和(mm) / (8 × 腿长(cm) × 10)) × 100`
- **底部按钮**：
  - "重新测试"按钮：关闭模态窗，重置实验状态，清空已完成测距数据
  - "导出数据"按钮：导出CSV格式文件
    - 点击后弹出文件保存对话框，选择导出地址
    - 文件名格式：`SEBT-序号-分数-时间（年月日）`
    - 示例：`SEBT-001-120-20250101`（序号001，分数120，日期2025年1月1日）
    - CSV格式：固定两行
      - 第一行：字段名（表头）
      - 第二行：数据（对应字段的值）
    - CSV字段包括：被测序号、被测性别、被测年龄、被测腿长、主机参数（锁定时长）、从机参数（稳定时长、压力最小阈值、压力最大阈值）、8方向读数（L, BL, FL, F, B, BR, FR, R）、测试分数

**实现方案**：
1. **UI层面**：
   - 修改按钮文本："开始实验"→"开始测试"，"停止实验"→"结束测试"
   - 创建实验记录模态窗HTML结构
   - 基础信息输入板块：表单布局，包含输入框、下拉选择、只读显示区域
   - 表格板块：8方向读数表格 + 测试分数显示
   - 底部按钮区域：重新测试、导出数据按钮

2. **逻辑层面**：
   - 修改`startExperiment()`和`stopExperiment()`函数中的按钮文本
   - 在`stopExperiment()`中弹出实验记录模态窗
   - 实现基础信息输入验证（序号、性别、年龄、腿长必填）
   - 实现8方向读数数据收集（从`completedDirections`和测距结果中获取）
   - 实现测试分数计算（注意单位换算）
   - 实现CSV导出功能（使用Electron的`dialog.showSaveDialog`）
   - 实现文件名自动生成（序号-分数-日期格式）
   - 实现重新测试功能（重置状态、清空数据）

3. **数据流程**：
   ```
   结束测试 → 弹出模态窗 → 输入基础信息 → 显示8方向读数和测试分数 → 导出CSV或重新测试
   ```

---

## 实施顺序建议

### Phase 1: 基础自动化 (P0 + P1修复) ✅ 已完成
1. **实现自动锁定功能**：
   - 添加"开始实验"按钮UI
   - 实现实验状态管理
   - 集成自动锁定逻辑到数据处理流程

2. **完善测距功能**：
   - 检查并修复现有测距bug
   - 优化测距流程和用户体验

### Phase 2: 高级自动化 (P2) ✅ 已完成
1. **实现AutoRun功能**：
   - 重命名UI控件
   - 实现自动测距流程
   - 添加智能方向选择逻辑

### Phase 3: 数据管理功能 (P3) ✅ 已完成
1. **✅ 按钮文本修改**：
   - 修改"开始实验"→"开始测试"
   - 修改"停止实验"→"结束测试"
   - 更新相关函数和事件处理

2. **✅ 实验记录模态窗**：
   - 创建模态窗HTML结构
   - 实现基础信息输入板块（表单验证）
   - 实现表格板块（8方向读数显示）
   - 实现测试分数计算（注意单位换算）
   - 实现实时数据更新机制（500ms定时器）

3. **✅ 导出功能**：
   - 实现CSV文件生成
   - 实现文件保存对话框
   - 实现文件名自动生成
   - 实现重新测试功能
   - 实现误触恢复功能

### Phase 4: Bug修复 (P3) ✅ 已完成
1. **✅ 修复数据更新问题**（v1.0.7）：
   - 调查并修复模态窗表格数据无法即时更新的根本原因
   - 使用`requestAnimationFrame`优化DOM更新时机
   - 简化数据读取逻辑，直接使用`measurementResults`作为数据源
   - 确保已完成方向的读数能实时显示在表格中

### Phase 5: UI优化和功能完善 (P3) ✅ 已完成
1. **✅ UI样式优化**（v1.0.8）：
   - 结束测试按钮改为红色背景
   - 模态窗标题改为"SEBT 数据记录"
   - 按钮布局优化（居中、间距调整、颜色优化）

2. **✅ 功能完善**（v1.0.8）：
   - 测试分数保留2位小数
   - 导出后自动重置状态
   - 日志输出优化

---

## 预期效果

### 用户体验目标
1. **简化操作**：从手动逐个方向测试，到一键启动全自动测试
2. **提高效率**：减少人工干预，加快测试速度
3. **状态清晰**：实时显示测试进度和当前状态
4. **错误容错**：完善的异常处理和状态恢复

### 技术实现目标
1. **模块化设计**：功能独立，可单独开关
2. **状态一致性**：完善的实验状态管理
3. **性能优化**：高效的数据处理和UI更新
4. **可维护性**：清晰的代码结构和注释

---

## 风险评估

### 潜在风险
1. **状态管理复杂性**：多状态并发可能导致状态不一致
2. **用户操作冲突**：自动流程中用户手动操作可能造成干扰
3. **性能影响**：频繁的数据处理可能影响UI响应

### 缓解措施
1. **状态机设计**：使用明确的状态机管理实验流程
2. **操作锁定**：实验运行时锁定相关手动操作
3. **异步处理**：合理使用异步处理避免阻塞UI

---

## P3需求详细说明

### 实验记录模态窗结构

#### 基础信息输入板块
```
┌─────────────────────────────────────┐
│ 被测序号: [输入框]                  │
│ 被测性别: [下拉选择: 男/女]          │
│ 被测年龄: [数字输入框]              │
│ 被测腿长: [数字输入框] cm           │
│                                     │
│ 主机参数:                           │
│   锁定时长: 10次 (只读显示)         │
│                                     │
│ 从机参数:                           │
│   稳定时长: 10次 (只读显示)         │
│   压力阈值范围: 500-3000 (只读显示) │
└─────────────────────────────────────┘
```

#### 表格板块
```
┌─────────────────────────────────────────────┐
│ 方向 │ L  │ BL │ FL │ F  │ B  │ BR │ FR │ R  │
├──────┼────┼────┼────┼────┼────┼────┼────┼────┤
│ 读数 │ 76 │ 82 │ 0  │ 95 │ 88 │ 0  │ 91 │ 0  │
└─────────────────────────────────────────────┘
测试分数: 120
```

#### 底部按钮
```
[重新测试]  [导出数据]
```

### 数据计算公式

#### 测试分数计算
```javascript
// 单位换算：腿长从cm转换为mm
const legLengthMm = legLengthCm * 10;

// 8个方向距离总和（单位：mm）
const totalDistance = distances.reduce((sum, dist) => sum + dist, 0);

// 测试分数计算
const testScore = (totalDistance / (8 * legLengthMm)) * 100;

// 取整显示
const testScoreRounded = Math.round(testScore);
```

**示例计算**：
- 假设8方向读数：L=76mm, BL=82mm, FL=0mm, F=95mm, B=88mm, BR=0mm, FR=91mm, R=0mm
- 总和：76 + 82 + 0 + 95 + 88 + 0 + 91 + 0 = 432mm
- 假设腿长：85cm = 850mm
- 测试分数 = (432 / (8 × 850)) × 100 = (432 / 6800) × 100 ≈ 6.35
- 取整后：6

### CSV导出格式

#### 文件名格式
```
SEBT-{序号}-{分数}-{日期}
示例：SEBT-001-120-20250101
```

#### CSV内容格式（固定两行）
```csv
被测序号,被测性别,被测年龄,被测腿长(cm),主机参数-锁定时长(次),从机参数-稳定时长(次),从机参数-压力最小阈值,从机参数-压力最大阈值,方向L(mm),方向BL(mm),方向FL(mm),方向F(mm),方向B(mm),方向BR(mm),方向FR(mm),方向R(mm),测试分数
001,男,25,85,10,10,500,3000,76,82,0,95,88,0,91,0,6
```

### 8方向读数数据来源

#### 已完成测距的方向
- 从`completedDirections`集合中获取已完成的方向
- 从`this.sensorData`或测距结果中获取对应的距离值
- 显示实际测距结果（mm单位）

#### 未完成测距的方向
- 不在`completedDirections`集合中的方向
- 在表格中显示为`0`

### 重新测试功能

点击"重新测试"按钮后执行：
1. 关闭实验记录模态窗
2. 重置实验状态（`experimentRunning = false`）
3. 清空已完成测距数据（`completedDirections.clear()`）
4. 清空锁定方向（`lockedDirections.clear()`）
5. 重置自动锁定计数状态
6. 更新按钮文本为"开始测试"
7. 隐藏实验状态显示组件

### 导出数据功能

#### 文件保存对话框
- 使用Electron的`dialog.showSaveDialog` API
- 默认文件名：`SEBT-{序号}-{分数}-{日期}.csv`
- 用户可以选择保存位置和修改文件名

#### CSV生成逻辑
1. 构建表头行（字段名）
2. 构建数据行（对应字段的值）
3. 将两行数据组合成CSV字符串
4. 使用`fs.writeFileSync`写入文件

---

## 已发现的问题

### P3: 实验记录模态窗数据更新问题 ✅ 已修复（v1.0.7）
**问题描述**：
- 实验记录模态窗内已完成测距方向的数值无法即时更新显示
- 表格中的distance-L、distance-BL等元素无法实时显示已完成方向的读数

**修复方案**：
1. **简化数据读取逻辑**：直接使用`measurementResults`作为数据源（与`calculateTestScore()`保持一致）
2. **优化DOM更新时机**：使用`requestAnimationFrame`确保DOM完全渲染后再更新
3. **性能优化**：批量收集更新操作，只在值变化时才更新DOM
4. **确保元素正确性**：验证元素在模态窗内，避免更新错误的元素

**修复效果**：
- ✅ 模态窗表格现在能正确显示已完成测距方向的实时读数
- ✅ 无论什么时候打开模态窗（测试一半时/测试完成后），都能立即显示当前已完成方向的读数
- ✅ 解决了主页面刷新闪烁导致的模态窗更新阻塞问题

---

### 模拟按钮禁用状态UI更新问题（待下一期修复）
**问题描述**：
- 模拟数据和模拟锁定按钮在BLE连接成功后，功能层面已被禁用（点击无响应）
- 但UI层面无法正确显示禁用状态（禁用光标、透明度等视觉反馈）
- 需要用户手动刷新页面或触发其他操作才能正确显示禁用状态

**影响范围**：
- 用户体验：按钮看起来仍然可用，但实际点击无效
- 视觉一致性：UI状态与实际功能状态不匹配

**临时解决方案**：
- 已在事件处理层添加功能禁用保护
- 按钮点击时会输出明确的禁用提示信息
- 用户可以通过查看控制台日志了解按钮已被禁用

**计划修复时间**：下一期迭代

---

## 后续功能规划

### P4: 从机数据并联调功能（计划中）

#### 功能概述
- **目标**：在BLE驱动和数据流程中加入从机数据并联调
- **从机职责**：控制"测距按钮"是否可用
- **判断条件**：同时满足从机稳定阈值参数和稳定时长参数后，才允许点击测距按钮

#### 技术实现

##### 1. 从机硬件代码（已完成）
- **文件**：`hardware core/slave-bt.ino`
- **BLE配置**：
  - Service UUID: `0000cccc-0000-1000-8000-00805f9b34fb`
  - Characteristic UUID: `0000dddd-0000-1000-8000-00805f9b34fb`
  - 设备名称: `SEBT-Slave-001`
- **数据格式**：JSON格式 `{pressure:3000}`
- **发送间隔**：300ms（与主机一致）

##### 2. BLE驱动页面集成（待实现）
- **当前状态**：主机和从机使用独立的BLE驱动页面
  - 主机：`public/ble-driver.html`
  - 从机：`public/slave-ble-driver.html`（已创建，待集成）
- **目标**：将主机和从机BLE驱动集成到统一页面
- **功能**：
  - 在同一页面内同时连接主机和从机设备
  - 通过Web Bluetooth API分别连接主机和从机
  - 接收主机传感器数据和从机压力数据
  - 通过WebSocket转发到Electron主进程
  - 连接状态与主页面同步
- **UI设计**：
  - 页面分为两个区域：主机连接区域和从机连接区域
  - 每个区域独立显示连接状态、连接按钮和数据日志
  - 主机区域显示8方向传感器数据
  - 从机区域显示压力传感器数据

##### 3. 数据流程集成（待实现）
```
ESP32-C3从机 → BLE Notify → 浏览器Web Bluetooth API → WebSocket → Electron主进程 → 渲染进程
```

##### 4. 测距按钮控制逻辑（待实现）
- **条件1**：方向已锁定（`lockedDirections.has(channel)`）
- **条件2**：从机压力值在阈值范围内（`pressure >= pressureMinThreshold && pressure <= pressureMaxThreshold`）
- **条件3**：从机压力值连续稳定达到稳定时长（`stableRequiredCount`次，默认10次）
- **AutoRun模式**：满足锁定条件后，再满足从机条件，自动触发测距

##### 5. 从机参数设置（UI已完成）
- **稳定时长**：从机模态窗内滑块控制（5-30次连续，默认10次）
- **压力阈值范围**：从机模态窗内双滑块控制（最小阈值-最大阈值）
- **参数来源**：从机模态窗UI设置，存储在`stableRequiredCount`、`pressureMinThreshold`、`pressureMaxThreshold`

#### 实现步骤

##### Phase 1: BLE驱动页面集成（待实现）
1. **统一BLE驱动页面**：
   - 将主机和从机BLE驱动集成到`public/ble-driver.html`
   - 页面布局：上下分区域或左右分区域
   - 主机区域：连接主机设备，显示8方向传感器数据
   - 从机区域：连接从机设备，显示压力传感器数据
   - 每个区域独立管理连接状态和日志

2. **Web Bluetooth API集成**：
   - 主机连接：使用主机BLE UUID（`0000aaaa-0000-1000-8000-00805f9b34fb`）
   - 从机连接：使用从机BLE UUID（`0000cccc-0000-1000-8000-00805f9b34fb`）
   - 支持同时连接两个设备
   - 独立处理两个设备的连接、断开和数据接收

3. **WebSocket数据转发**：
   - 主机数据：二进制格式，23字节数据包
   - 从机数据：JSON格式，`{pressure:3000}`
   - 通过WebSocket统一转发到Electron主进程
   - 数据包包含来源标识（host/slave）

##### Phase 2: BLE驱动层集成（待实现）
1. **主进程WebSocket处理**：
   - 接收统一BLE驱动页面的WebSocket数据
   - 根据数据来源标识（host/slave）分别处理
   - 主机数据：解析23字节二进制数据包
   - 从机数据：解析JSON格式的压力数据：`{pressure:3000}`
   - 通过IPC转发到渲染进程

2. **渲染进程数据接收**：
   - 监听主机传感器数据IPC事件
   - 监听从机压力数据IPC事件
   - 存储压力值到`currentPressure`
   - 更新主机和从机连接状态

##### Phase 3: 测距按钮控制逻辑（待实现）
1. **压力稳定性判断**：
   - 维护压力值历史记录（最近N次读数）
   - 判断压力值是否在阈值范围内
   - 判断压力值是否连续稳定达到稳定时长

2. **测距按钮状态管理**：
   - 锁定方向后，检查从机条件
   - 满足条件时启用测距按钮
   - 不满足条件时禁用测距按钮（显示禁用状态）

3. **AutoRun模式集成**：
   - 锁定方向后，等待从机条件满足
   - 条件满足后自动触发测距
   - 条件不满足时继续等待

##### Phase 4: UI反馈优化（待实现）
1. **测距按钮状态显示**：
   - 启用状态：正常显示，可点击
   - 禁用状态：灰色显示，显示"等待从机稳定"提示

2. **从机状态显示**：
   - **主页面中心卡片压力值显示**（新增需求）：
     - 位置：主页面3x3网格的中心卡片（`.grid-item.center`）内
     - 显示位置：在"平衡测试系统"文字的下方
     - 显示格式：`pressure：xxxx`（xxxx为实时压力值）
     - 数据来源：通过WebSocket接收从机压力数据后实时刷新
     - 实现方式：
       - 修改`createLogoContent()`函数，添加压力值显示元素（`<div id="pressure-display">pressure：--</div>`）
       - 添加`updatePressureDisplay(pressure)`函数，更新压力值显示
       - 在接收从机压力数据的IPC事件处理中调用`updatePressureDisplay()`
     - 样式：与"平衡测试系统"文字样式保持一致或使用合适的字体大小和颜色
   - 实时显示当前压力值（在中心卡片）
   - 显示压力稳定性进度（X/10次）
   - 显示压力是否在阈值范围内

#### 数据流设计

##### 统一BLE驱动页面数据流
```
主机数据流：
ESP32-C3主机 (硬件端)
    ↓ [23字节二进制数据包]
BLE Notify (NimBLE-Arduino)
    ↓ [BLE无线通信]
浏览器 Web Bluetooth API (ble-driver.html - 主机区域)
    ↓ [WebSocket客户端: {type: 'host_sensor_data', ...}]
Electron WebSocket服务器 (端口3000)
    ↓ [IPC事件: bluetooth-data-received]
app.js (渲染进程/前端)
    ↓ [handleHostBroadcast处理]
    ↓ [DOM更新]
用户界面 (8方向传感器网格)

从机数据流：
ESP32-C3从机 (硬件端)
    ↓ [JSON格式: {pressure:3000}]
BLE Notify (NimBLE-Arduino)
    ↓ [BLE无线通信]
浏览器 Web Bluetooth API (ble-driver.html - 从机区域)
    ↓ [WebSocket客户端: {type: 'slave_pressure_data', ...}]
Electron WebSocket服务器 (端口3000)
    ↓ [IPC事件: slave-pressure-data-received]
app.js (渲染进程/前端)
    ↓ [压力稳定性判断]
    ↓ [测距按钮状态更新]
用户界面 (测距按钮启用/禁用)
```

##### 测距按钮控制流程
```
1. 方向锁定 → 检查从机连接状态
2. 从机已连接 → 检查压力值是否在阈值范围内
3. 压力值在范围内 → 开始计数连续稳定次数
4. 连续稳定次数达到稳定时长 → 启用测距按钮
5. AutoRun模式 → 自动触发测距
```

#### 关键变量设计
```javascript
// 从机相关变量
this.currentPressure = 0; // 当前压力值
this.pressureHistory = []; // 压力值历史记录（用于稳定性判断）
this.pressureStableCount = 0; // 压力值连续稳定次数
this.pressureInRange = false; // 压力值是否在阈值范围内
this.slaveDeviceConnected = false; // 从机连接状态（已有）
this.stableRequiredCount = 10; // 稳定时长连续次数（已有）
this.pressureMinThreshold = 500; // 压力最小阈值（已有）
this.pressureMaxThreshold = 3000; // 压力最大阈值（已有）
```

#### 预期效果
1. **用户体验**：测距按钮只在从机条件满足时可用，避免误操作
2. **数据准确性**：确保测距时从机压力值稳定，提高测试准确性
3. **自动化流程**：AutoRun模式下自动等待从机条件，完全自动化测试流程
4. **状态反馈**：实时显示从机状态和测距按钮可用性，用户清楚了解当前状态
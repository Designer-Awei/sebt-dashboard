# SEBT 平衡测试系统

基于 Electron 的桌面平衡测试仪表板应用，采用 **ESP32-C3 + BLE + WebSocket Bridge** 架构，通过TCA9548A管理8路ToF传感器，实现实时数据采集和可视化。

## 📋 版本信息

**当前版本**: v1.0.9 - ESP32-C3 + BLE + WebSocket Bridge架构 + 自动化测试功能 + 实验记录导出 + UI优化 + 桌面应用打包
**硬件平台**: ESP32-C3 (400KB RAM, 160MHz)  
**通信方式**: BLE Notify + WebSocket Bridge
**状态**: ✅ 生产就绪

## 🎯 核心功能

- ✅ **8方向ToF传感器**: 通过TCA9548A多路复用器管理8个VL53L1X传感器
- ✅ **BLE原生通信**: ESP32-C3直接通过BLE Notify发送传感器数据
- ✅ **WebSocket Bridge**: Electron主进程创建WebSocket服务器作为数据中转
- ✅ **Web Bluetooth API**: 浏览器直接连接BLE设备，无需串口通信
- ✅ **实时数据可视化**: 23字节二进制数据包，每300ms更新一次
- ✅ **跨进程通信**: BLE → 浏览器 → WebSocket → Electron → UI
- ✅ **自动锁定功能**: 当同一方向连续达到N次为最近距离时，自动锁定该方向
- ✅ **AutoRun功能**: 自动执行"锁定→测距→下一个方向"的完整循环，无需手动干预
- ✅ **实验状态管理**: 支持开始/停止测试，实时显示测试状态和时长
- ✅ **实验记录功能**: 结束测试时自动弹出记录模态窗，显示8方向读数和测试分数（保留2位小数）
- ✅ **CSV导出功能**: 支持导出实验数据为CSV格式，文件名自动生成，导出后自动重置状态
- ✅ **误触恢复功能**: 误触结束测试后，可通过关闭按钮恢复测试状态
- ✅ **UI优化**: 红色结束测试按钮、优化的按钮布局和颜色、精简的日志输出
- 🔄 **从机BLE驱动**: 已创建从机BLE驱动页面，计划集成到主机BLE驱动页面（待实现）
- 🔄 **压力值显示**: 计划在主页面中心卡片显示从机压力值（格式：pressure：xxxx，待实现）
- ✅ **桌面应用打包**: 支持生成Windows安装程序和便携版，包含多尺寸图标

## 🔧 硬件连接

### ESP32-C3引脚连接

| 模块 | ESP32-C3引脚 | 说明 |
|------|-------------|------|
| TCA9548A SDA | GPIO 8 | I2C数据线 |
| TCA9548A SCL | GPIO 9 | I2C时钟线 |
| LED状态指示 | GPIO 10 | 可选，用于连接状态指示 |

### 8个VL53L1X传感器
通过TCA9548A的8个通道连接（SC0-SD0到SC7-SD7）

### BLE配置

#### 主机BLE配置
- **Service UUID**: `0000aaaa-0000-1000-8000-00805f9b34fb`
- **Characteristic UUID**: `0000bbbb-0000-1000-8000-00805f9b34fb`
- **设备名称**: `SEBT-Host-001`
- **特征属性**: `READ | NOTIFY`

#### 从机BLE配置
- **Service UUID**: `0000cccc-0000-1000-8000-00805f9b34fb`
- **Characteristic UUID**: `0000dddd-0000-1000-8000-00805f9b34fb`
- **设备名称**: `SEBT-Slave-001`
- **特征属性**: `READ | NOTIFY`
- **数据格式**: JSON格式 `{pressure:3000}`
- **发送间隔**: 300ms（与主机一致）

## ⚙️ 配置步骤

### 1. Arduino IDE配置

- 安装ESP32开发板支持包
- 选择开发板：**ESP32C3 Dev Module**
- **USB CDC On Boot**: **Enabled**（重要！）
- USB Mode：Hardware CDC and JTAG
- 上传速度：921600

### 2. 安装NimBLE-Arduino库

在Arduino IDE中安装NimBLE-Arduino库：
1. 打开Arduino IDE
2. 工具 → 管理库
3. 搜索"NimBLE-Arduino"
4. 安装最新版本

### 3. 烧录ESP32-C3固件

1. 打开 `hardware core/master-ble.ino`
2. 选择正确的开发板和端口
3. 点击上传
4. 打开串口监视器查看启动日志

### 4. BLE设备连接测试

ESP32-C3上电后会自动：
- 初始化8个VL53L1X传感器
- 启动BLE广播
- 等待客户端连接

**查看BLE设备**：
- Windows: 设置 → 设备 → 添加蓝牙或其他设备
- 查找设备名称：`SEBT-Host-001`
5. 等待5-10秒，Windows会创建COM端口（COM8、COM9）

### 5. 运行测试

```bash
# 安装依赖
npm install

# 运行测试脚本（自动扫描并连接COM9）
npm run test-bt

# 检查SPP服务状态（如需要）
npm run check-spp
```

## 📊 数据格式

### 数据包结构（23字节）

```
[时间戳(4字节)] [最小方向(1字节)] [最小距离(2字节)] [8方向距离(16字节)]
```

### 数据示例

```
📊 [21:23:17] 方向4:80mm | 0:93 1:142 2:135 3:130 4:80 5:189 6:192 7:161mm
```

- **时间戳**: 32位无符号整数（millis()）
- **最小方向**: 0-7（8个方向），255表示无效
- **最小距离**: 16位无符号整数（mm）
- **8方向距离**: 每个方向2字节，共16字节

### BLE通信特性

- **通信协议**: BLE Notify（无连接确认）
- **发送间隔**: 300ms
- **数据可靠性**: 硬件端只在有BLE客户端连接时发送数据

## ⚠️ 重要注意事项

### 1. BLE连接要求
- **浏览器支持**: 需要支持Web Bluetooth API的浏览器（Chrome/Edge）
- **HTTPS要求**: 在HTTP环境下需要用户手势触发BLE请求
- **权限确认**: 首次连接时需要用户确认BLE设备访问权限

### 2. BLE设备发现
- ESP32-C3上电后自动开始广播
- 设备名称：`SEBT-Host-001`
- 广播间隔：BLE标准间隔
- 连接成功后开始发送传感器数据

### 3. 硬件连接检查
- HC-05 TXD → ESP32 GPIO 3 (RX) ⚠️ 注意方向
- HC-05 RXD → ESP32 GPIO 4 (TX) ⚠️ 注意方向
- 确认TX/RX没有接反

### 4. 波特率一致性
- ESP32-C3、HC-05、Windows端都必须使用**9600波特率**

### 5. USB CDC设置
- ESP32-C3的**USB CDC On Boot必须设置为Enabled**
- 否则串口监视器无法显示日志

## 🔍 故障排查

### 问题：测试脚本无法连接

1. **检查SPP服务连接状态**
   ```bash
   npm run check-spp
   ```

2. **检查ESP32-C3是否发送数据**
   - 查看串口监视器（115200波特率）
   - 应该看到 "BT: 23B Dir:X Dist:XXXmm OK"

3. **检查HC-05 LED状态**
   - 快速闪烁（约2次/秒）= ✅ 正常，已配对
   - 慢速闪烁（约1次/2秒）= ❌ 未配对

4. **检查硬件连接**
   - 确认TX/RX没有接反
   - 确认电源连接正确（5V）

### 问题：串口监视器无输出

- 检查**USB CDC On Boot**是否设置为**Enabled**
- 检查串口监视器波特率是否为115200
- 检查换行符设置（Both NL & CR）

## 📁 项目结构

```
sebt-dashboard/
├── main.js                    # Electron 主进程
├── app.js                     # 渲染进程主逻辑
├── index.html                 # 主界面HTML
├── public/                    # 公共资源目录
│   ├── ble-driver.html        # 主机BLE驱动页面
│   └── slave-ble-driver.html # 从机BLE驱动页面
├── hardware core/             # 硬件代码目录
│   ├── master-ble.ino         # ESP32-C3主机程序（生产代码）
│   └── slave-bt.ino           # ESP32-C3从机程序（生产代码）
└── README.md                  # 本文档
```

## 🚀 快速开始

```bash
# 1. 安装依赖
npm install

# 2. 配置HC-05（使用Arduino Nano）
# 参考上述"HC-05配置"章节

# 3. 烧录ESP32-C3固件
# 上传 hardware core/master-ble.ino（主机）或 hardware core/slave-bt.ino（从机）

# 4. 配对HC-05到Windows
# 在Windows蓝牙设置中配对，并启用SPP服务

# 5. 运行测试
npm run test-bt
```

## 📝 配置参数总结

### HC-05配置（最终确认）
- **设备名称**: `SEBT-Host-001`
- **配对密码**: `1234`
- **角色**: 从机模式（`AT+ROLE=0`）
- **通信波特率**: `9600` (`AT+UART=9600,0,0`)

### ESP32-C3配置
- **HC-05 RX**: GPIO 3
- **HC-05 TX**: GPIO 4
- **I2C SDA**: GPIO 8
- **I2C SCL**: GPIO 9
- **通信波特率**: 9600
- **数据发送间隔**: 300ms

### Windows端配置
- **推荐端口**: **COM9（传出端口/SPP Dev）**
- **波特率**: 9600
- **数据位**: 8
- **停止位**: 1
- **校验位**: 无

## 🔗 相关文档

- **public/ble-driver.html**: BLE驱动页面（当前仅支持主机，计划集成从机）
- **public/slave-ble-driver.html**: 从机BLE驱动页面（已创建，计划集成到主驱动页面）
- **hardware core/master-ble.ino**: ESP32-C3主机程序，包含完整的传感器读取和BLE发送逻辑
- **hardware core/slave-bt.ino**: ESP32-C3从机程序，包含压力传感器读取和BLE发送逻辑

## ✅ 验证状态

- ✅ HC-05配置完成
- ✅ ESP32-C3固件烧录成功
- ✅ Windows配对成功
- ✅ SPP服务连接成功
- ✅ 数据接收正常（COM9）
- ✅ 数据解析正确

## 📖 项目背景

### 项目概述

SEBT (Smart Electronic Balance Testing) 平衡测试系统是一个基于 **中心化边缘计算** 架构的智能平衡评估平台。系统采用 **主机-服务端** 架构，通过 **HC-05经典蓝牙SPP串口通信** 实现实时数据采集、处理和可视化。

### 项目目标

- **精准测量**: 通过8路ToF传感器精确测量人体平衡测试中的距离数据（30-4000mm）
- **实时反馈**: 300ms更新间隔，为用户提供即时平衡状态反馈
- **自动化测试**: 全自动化的平衡测试流程，无需人工干预
- **数据可视化**: 直观的PC端仪表板，实时显示8方向传感器数据

### 系统架构

```
┌─────────────────────────────────────────────────────────┐
│                    PC端 (Electron应用)                  │
│  ┌──────────────────────────────────────────────────┐  │
│  │  自动扫描蓝牙串口 → 连接COM9 → 接收23字节数据包  │  │
│  │  解析数据 → 显示8方向距离 → 实时可视化            │  │
│  └──────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────┘
                        ↕ HC-05经典蓝牙SPP
┌─────────────────────────────────────────────────────────┐
│              ESP32-C3主机 (硬件端)                       │
│  ┌──────────────────────────────────────────────────┐  │
│  │  TCA9548A多路复用器 → 8路VL53L1X ToF传感器        │  │
│  │  读取传感器数据 → 打包23字节数据包 → HC-05发送    │  │
│  └──────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────┘
```

### 技术架构特点

- **硬件平台**: ESP32-C3 (400KB RAM, 160MHz主频) - 充足内存支持8个传感器对象
- **通信方式**: HC-05经典蓝牙SPP串口通信 - 稳定可靠，避免BLE半双工问题
- **数据格式**: 23字节二进制数据包 - 紧凑高效，包含完整传感器数据
- **自动连接**: Node.js脚本自动扫描并连接蓝牙串口 - 无需手动配置COM端口

### 当前实现状态

✅ **生产就绪**
- ✅ ESP32-C3固件完成（`test-bt-esp32c3.ino`）
- ✅ HC-05配置完成（设备名：SEBT-Host-001，密码：1234）
- ✅ Windows配对和SPP服务连接成功
- ✅ 数据接收和解析正常（COM9端口）
- ✅ 8方向ToF传感器数据实时显示

### 技术栈

**软件端**:
- Electron: 跨平台桌面应用框架
- Node.js: 后端运行环境
- serialport: 串口通信库（连接HC-05）
- HTML/CSS/JavaScript: 现代化响应式前端界面

**硬件端**:
- ESP32-C3: 主控芯片（400KB RAM, 160MHz主频）
- HC-05: 经典蓝牙模块（SPP串口通信）
- TCA9548A: I2C多路复用器（管理8个传感器）
- VL53L1X: ToF距离传感器（8个，30-4000mm测量范围）

**通信协议**:
- 经典蓝牙SPP: HC-05模块提供串口通信
- 二进制数据包: 23字节紧凑格式（时间戳+方向+距离数据）
- 自动串口扫描: Node.js脚本自动识别并连接蓝牙串口

### 系统优势

- ✅ **高可靠性**: HC-05经典蓝牙提供稳定的串口通信
- ✅ **大内存支持**: ESP32-C3的400KB RAM完全支持8个传感器对象
- ✅ **易用性**: 自动串口扫描，无需手动配置COM端口
- ✅ **实时性**: 300ms数据更新间隔，毫秒级响应
- ✅ **扩展性**: 预留从机FSR设备接口（未来扩展）

## 📅 更新记录

### v1.0.9 (2025-01)
- 📦 **桌面应用打包**：配置electron-builder，支持生成Windows安装程序和便携版
- 🎨 **图标转换**：自动将PNG图标转换为多尺寸ICO文件（16x16到256x256）
- 🧹 **依赖清理**：移除冗余的原生模块依赖（@stoprocent/noble, serialport等）
- 🔧 **构建优化**：配置跳过原生模块重新编译，避免需要Visual Studio
- 📝 **文档更新**：更新打包说明和依赖清理记录

### v1.0.7 (2025-01)
- 🎨 UI优化：结束测试按钮改为红色背景，更醒目
- 🎨 UI优化：模态窗标题改为"SEBT 数据记录"
- 🎨 UI优化：按钮布局优化（居中、间距调整、颜色优化）
- 🔧 功能优化：测试分数保留2位小数显示
- 🔧 功能优化：导出成功后自动重置状态
- 🔧 功能优化：日志输出优化，减少重复日志
- 🔧 从机硬件代码：更新从机BLE UUID格式，与主机保持一致
- 🔧 从机BLE驱动：创建从机BLE驱动页面（`slave-ble-driver.html`）

### v1.0.6 (2025-01)
- ✨ 新增实验记录和导出功能：结束测试时弹出记录模态窗，支持CSV导出
- ✨ 新增测试分数计算：自动计算并实时显示测试分数
- ✨ 新增误触恢复功能：点击关闭按钮可恢复测试状态，继续测试
- 🔧 优化数据同步：模态窗实时更新已完成测距方向的读数
- 🐛 修复：模态窗表格数据更新问题（详见项目更新日志.md）

### v1.0.5 (2025-01)
- ✨ 新增自动锁定功能：开始实验后自动锁定最近方向
- ✨ 新增AutoRun功能：自动执行锁定→测距→下一个方向的完整循环
- ✨ 新增实验状态显示：实时显示实验运行状态和时长
- 🔧 优化日志显示：改为从上到下刷新，自动滚动到最新日志
- 🔧 精简日志内容：移除重复和琐碎信息
- 🔧 优化数据处理流程：提高数据更新实时性
- 🐛 修复多个UI和功能bug（详见项目更新日志.md）

---

**许可证**: ISC License  
**最后更新**: 2025年1月（v1.0.9）
**详细更新日志**: 请查看 [项目更新日志.md](./项目更新日志.md)

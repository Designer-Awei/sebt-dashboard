# SEBT 平衡测试系统

基于 Electron 的桌面平衡测试仪表板应用，采用 **ESP32-C3 + HC-05经典蓝牙** 架构，通过TCA9548A管理8路ToF传感器，实现实时数据采集和可视化。

## 📋 版本信息

**当前版本**: v5.0 - ESP32-C3 + HC-05经典蓝牙架构  
**硬件平台**: ESP32-C3 (400KB RAM, 160MHz)  
**通信方式**: HC-05经典蓝牙SPP串口通信  
**状态**: ✅ 生产就绪

## 🎯 核心功能

- ✅ **8方向ToF传感器**: 通过TCA9548A多路复用器管理8个VL53L1X传感器
- ✅ **经典蓝牙通信**: HC-05模块提供稳定的SPP串口通信
- ✅ **自动串口扫描**: 测试脚本自动识别并连接蓝牙串口（优先COM9）
- ✅ **实时数据可视化**: 23字节二进制数据包，每300ms更新一次
- ✅ **大内存支持**: ESP32-C3的400KB RAM完全支持8个传感器对象

## 🔧 硬件连接

### ESP32-C3引脚连接

| 模块 | ESP32-C3引脚 | 说明 |
|------|-------------|------|
| TCA9548A SDA | GPIO 8 | I2C数据线 |
| TCA9548A SCL | GPIO 9 | I2C时钟线 |
| HC-05 TXD | GPIO 3 | ESP32接收 |
| HC-05 RXD | GPIO 4 | ESP32发送 |
| HC-05 VCC | 5V | 电源（不需要EN引脚） |
| HC-05 GND | GND | 地 |

### 8个VL53L1X传感器
通过TCA9548A的8个通道连接（SC0-SD0到SC7-SD7）

## ⚙️ 配置步骤

### 1. Arduino IDE配置

- 安装ESP32开发板支持包
- 选择开发板：**ESP32C3 Dev Module**
- **USB CDC On Boot**: **Enabled**（重要！）
- USB Mode：Hardware CDC and JTAG
- 上传速度：921600

### 2. HC-05配置（使用Arduino Nano）

**硬件连接**（HC-05与Nano共用电源）：
- HC-05 VCC → Nano 5V
- HC-05 GND → Nano GND
- HC-05 TXD → Nano D3
- HC-05 RXD → Nano D4
- HC-05 EN → Nano D2（可选）

**配置流程**：
1. 上传 `hardware core/hc05-config-nano.ino` 到Arduino Nano
2. 打开串口监视器（115200波特率，Both NL & CR）
3. 断开HC-05电源，按住按钮，上电，松开按钮（进入AT模式）
4. 发送以下AT命令：

```bash
AT                    # 测试AT模式
AT+NAME=SEBT-Host-001 # 设置设备名称
AT+PSWD="1234"        # 设置配对密码（注意需要引号）
AT+ROLE=0             # 设置为从机模式
AT+UART=9600,0,0      # 设置波特率9600
AT+NAME?              # 查询确认配置
```

5. 配置完成后，断开HC-05电源，重新上电（不按按钮）退出AT模式

### 3. 烧录ESP32-C3固件

上传 `hardware core/test-bt-esp32c3.ino` 到ESP32-C3

### 4. Windows配对HC-05

1. 打开"设置" > "蓝牙和其他设备"
2. 添加设备 > 蓝牙
3. 找到"SEBT-Host-001"，输入密码：**1234**
4. **重要**：配对后，点击设备 > 更多蓝牙选项 > 服务，确保**"串行端口(SPP)"已勾选**
5. 等待5-10秒，Windows会创建COM端口（COM8、COM9）

### 5. 运行测试

```bash
# 安装依赖
npm install

# 运行测试脚本（自动扫描并连接COM9）
npm run test-bt

# 检查SPP服务状态（如需要）
npm run check-spp
```

## 📊 数据格式

### 数据包结构（23字节）

```
[时间戳(4字节)] [最小方向(1字节)] [最小距离(2字节)] [8方向距离(16字节)]
```

### 数据示例

```
📊 [21:23:17] 方向4:80mm | 0:93 1:142 2:135 3:130 4:80 5:189 6:192 7:161mm
```

- **时间戳**: 32位无符号整数（millis()）
- **最小方向**: 0-7（8个方向），255表示无效
- **最小距离**: 16位无符号整数（mm）
- **8方向距离**: 每个方向2字节，共16字节

## ⚠️ 重要注意事项

### 1. SPP服务必须手动启用
- Windows创建COM端口 ≠ SPP服务已连接
- 必须在蓝牙设置中手动启用"串行端口(SPP)"服务
- 这是最常见的连接失败原因

### 2. 端口选择
- **COM9（传出端口/SPP Dev）** ✅ **推荐使用** - 可以接收数据
- COM8（传入端口）虽然可以打开，但未收到数据
- 测试脚本已自动优先使用COM9

### 3. 硬件连接检查
- HC-05 TXD → ESP32 GPIO 3 (RX) ⚠️ 注意方向
- HC-05 RXD → ESP32 GPIO 4 (TX) ⚠️ 注意方向
- 确认TX/RX没有接反

### 4. 波特率一致性
- ESP32-C3、HC-05、Windows端都必须使用**9600波特率**

### 5. USB CDC设置
- ESP32-C3的**USB CDC On Boot必须设置为Enabled**
- 否则串口监视器无法显示日志

## 🔍 故障排查

### 问题：测试脚本无法连接

1. **检查SPP服务连接状态**
   ```bash
   npm run check-spp
   ```

2. **检查ESP32-C3是否发送数据**
   - 查看串口监视器（115200波特率）
   - 应该看到 "BT: 23B Dir:X Dist:XXXmm OK"

3. **检查HC-05 LED状态**
   - 快速闪烁（约2次/秒）= ✅ 正常，已配对
   - 慢速闪烁（约1次/2秒）= ❌ 未配对

4. **检查硬件连接**
   - 确认TX/RX没有接反
   - 确认电源连接正确（5V）

### 问题：串口监视器无输出

- 检查**USB CDC On Boot**是否设置为**Enabled**
- 检查串口监视器波特率是否为115200
- 检查换行符设置（Both NL & CR）

## 📁 项目结构

```
sebt-dashboard/
├── main.js                    # Electron 主进程
├── app.js                     # 渲染进程主逻辑
├── index.html                 # 主界面HTML
├── test-bt-receiver.js        # ⭐ HC-05蓝牙测试脚本（主要参考）
├── check-spp-service.ps1      # SPP服务诊断工具
├── hardware core/             # 硬件代码目录
│   ├── test-bt-esp32c3.ino    # ⭐ ESP32-C3主程序（生产代码）
│   └── hc05-config-nano.ino   # HC-05配置工具
└── README.md                  # 本文档
```

## 🚀 快速开始

```bash
# 1. 安装依赖
npm install

# 2. 配置HC-05（使用Arduino Nano）
# 参考上述"HC-05配置"章节

# 3. 烧录ESP32-C3固件
# 上传 hardware core/test-bt-esp32c3.ino

# 4. 配对HC-05到Windows
# 在Windows蓝牙设置中配对，并启用SPP服务

# 5. 运行测试
npm run test-bt
```

## 📝 配置参数总结

### HC-05配置（最终确认）
- **设备名称**: `SEBT-Host-001`
- **配对密码**: `1234`
- **角色**: 从机模式（`AT+ROLE=0`）
- **通信波特率**: `9600` (`AT+UART=9600,0,0`)

### ESP32-C3配置
- **HC-05 RX**: GPIO 3
- **HC-05 TX**: GPIO 4
- **I2C SDA**: GPIO 8
- **I2C SCL**: GPIO 9
- **通信波特率**: 9600
- **数据发送间隔**: 300ms

### Windows端配置
- **推荐端口**: **COM9（传出端口/SPP Dev）**
- **波特率**: 9600
- **数据位**: 8
- **停止位**: 1
- **校验位**: 无

## 🔗 相关文档

- **test-bt-receiver.js**: 主要测试脚本，展示完整的连接和数据接收实现
- **hardware core/test-bt-esp32c3.ino**: ESP32-C3主程序，包含完整的传感器读取和蓝牙发送逻辑

## ✅ 验证状态

- ✅ HC-05配置完成
- ✅ ESP32-C3固件烧录成功
- ✅ Windows配对成功
- ✅ SPP服务连接成功
- ✅ 数据接收正常（COM9）
- ✅ 数据解析正确

## 📖 项目背景

### 项目概述

SEBT (Smart Electronic Balance Testing) 平衡测试系统是一个基于 **中心化边缘计算** 架构的智能平衡评估平台。系统采用 **主机-服务端** 架构，通过 **HC-05经典蓝牙SPP串口通信** 实现实时数据采集、处理和可视化。

### 项目目标

- **精准测量**: 通过8路ToF传感器精确测量人体平衡测试中的距离数据（30-4000mm）
- **实时反馈**: 300ms更新间隔，为用户提供即时平衡状态反馈
- **自动化测试**: 全自动化的平衡测试流程，无需人工干预
- **数据可视化**: 直观的PC端仪表板，实时显示8方向传感器数据

### 系统架构

```
┌─────────────────────────────────────────────────────────┐
│                    PC端 (Electron应用)                  │
│  ┌──────────────────────────────────────────────────┐  │
│  │  自动扫描蓝牙串口 → 连接COM9 → 接收23字节数据包  │  │
│  │  解析数据 → 显示8方向距离 → 实时可视化            │  │
│  └──────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────┘
                        ↕ HC-05经典蓝牙SPP
┌─────────────────────────────────────────────────────────┐
│              ESP32-C3主机 (硬件端)                       │
│  ┌──────────────────────────────────────────────────┐  │
│  │  TCA9548A多路复用器 → 8路VL53L1X ToF传感器        │  │
│  │  读取传感器数据 → 打包23字节数据包 → HC-05发送    │  │
│  └──────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────┘
```

### 技术架构特点

- **硬件平台**: ESP32-C3 (400KB RAM, 160MHz主频) - 充足内存支持8个传感器对象
- **通信方式**: HC-05经典蓝牙SPP串口通信 - 稳定可靠，避免BLE半双工问题
- **数据格式**: 23字节二进制数据包 - 紧凑高效，包含完整传感器数据
- **自动连接**: Node.js脚本自动扫描并连接蓝牙串口 - 无需手动配置COM端口

### 当前实现状态

✅ **生产就绪**
- ✅ ESP32-C3固件完成（`test-bt-esp32c3.ino`）
- ✅ HC-05配置完成（设备名：SEBT-Host-001，密码：1234）
- ✅ Windows配对和SPP服务连接成功
- ✅ 数据接收和解析正常（COM9端口）
- ✅ 8方向ToF传感器数据实时显示

### 技术栈

**软件端**:
- Electron: 跨平台桌面应用框架
- Node.js: 后端运行环境
- serialport: 串口通信库（连接HC-05）
- HTML/CSS/JavaScript: 现代化响应式前端界面

**硬件端**:
- ESP32-C3: 主控芯片（400KB RAM, 160MHz主频）
- HC-05: 经典蓝牙模块（SPP串口通信）
- TCA9548A: I2C多路复用器（管理8个传感器）
- VL53L1X: ToF距离传感器（8个，30-4000mm测量范围）

**通信协议**:
- 经典蓝牙SPP: HC-05模块提供串口通信
- 二进制数据包: 23字节紧凑格式（时间戳+方向+距离数据）
- 自动串口扫描: Node.js脚本自动识别并连接蓝牙串口

### 系统优势

- ✅ **高可靠性**: HC-05经典蓝牙提供稳定的串口通信
- ✅ **大内存支持**: ESP32-C3的400KB RAM完全支持8个传感器对象
- ✅ **易用性**: 自动串口扫描，无需手动配置COM端口
- ✅ **实时性**: 300ms数据更新间隔，毫秒级响应
- ✅ **扩展性**: 预留从机FSR设备接口（未来扩展）

## 📅 更新记录

- **2025-01**: 确认COM9（传出端口）可以接收数据，更新测试脚本优先使用COM9
- **2025-01**: 精简文档，合并所有MD文件到README
- **2025-01**: 添加项目背景板块

---

**许可证**: ISC License  
**最后更新**: 2025年1月

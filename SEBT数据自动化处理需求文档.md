# SEBT数据自动化处理功能需求文档

## 现有代码分析

### 已实现的代码功能
1. **基础架构**：
   - 8方向传感器数据处理（方位映射：L, BL, FL, F, B, BR, FR, R）
   - 传感器数据存储和管理（Map结构）
   - UI网格布局（3x3，中心为LOGO）

2. **锁定功能基础**：
   - 锁定方向集合 (`lockedDirections`) 和完成测距集合 (`completedDirections`)
   - 锁定状态管理（`lockDirection()`, `resetLockedDirections()`）
   - 蓝色高亮锁定卡片样式
   - 锁定时长参数设置（主机模态窗内滑块控制）

3. **手动测距功能**：
   - 测距按钮显示逻辑（只在锁定方向显示）
   - 手动测距流程（`performManualMeasurement()`）
   - 测距数据收集（最近3次取平均值）
   - 测距结果处理（`handleManualMeasurementResult()`）
   - 完成测距状态管理

4. **实时数据显示**：
   - 绿色高亮最近距离方向（`highlightClosestDirection()`）
   - 距离数据实时更新
   - 高亮互斥逻辑（蓝色锁定优先级高于绿色高亮）

5. **模拟功能**：
   - 模拟传感器数据生成
   - 模拟锁定功能
   - 设备连接状态管理

### 代码中的关键变量和常量
```javascript
// 自动锁定相关常量
this.HARDWARE_SEND_INTERVAL_MS = 300; // 硬件发送间隔
this.LOCK_REQUIRED_COUNT = 10; // 默认锁定连续次数
this.AUTO_LOCK_TIME_MS = this.LOCK_REQUIRED_COUNT * this.HARDWARE_SEND_INTERVAL_MS;

// 状态集合
this.lockedDirections = new Set(); // 已锁定方向
this.completedDirections = new Set(); // 已完成测距方向

// 自动锁定状态跟踪
this.currentMinDirection = -1;
this.minDirectionStartTime = 0;
this.minDirectionConsecutiveCount = 0;
```

### UI控件现状
- **controls区域**：包含"AutoRun"开关、"模拟数据"按钮、"模拟锁定"按钮、"重置状态"按钮、**✅ "开始实验"按钮**
- **锁定参数设置**：主机模态窗内有锁定时长滑块（5-30次连续，默认10次）
- **卡片交互**：锁定方向显示手动测距按钮

### 已完成的功能
- **✅ P0 UI层面**：开始实验按钮已添加到controls区域
- **✅ P2 UI层面**：开启/关闭锁定已重命名为"AutoRun"

---

## 功能需求规划

### 功能优先级排序

#### P0: 自动锁定功能（核心功能）
**需求描述**：
- 在主页面controls容器内新增"开始实验"按钮
- 点击"开始实验"后，开始连续监测传感器数据
- 当同一方向连续达到N次（主机模态窗参数）为最近距离时，自动锁定该方向
- 锁定状态：卡片显示蓝色高亮，只能同时锁定一个方向
- 锁定期间，绿色实时高亮暂停显示（防止视觉冲突）

**实现方案**：
1. **UI层面**：
   - 在controls区域添加"开始实验"按钮
   - 按钮状态管理（开始实验/停止实验）
   - 实验状态指示器

2. **逻辑层面**：
   - 新增实验状态管理（`experimentRunning`）
   - 扩展现有自动锁定计数逻辑（`handleAutoLock()`）
   - 集成到传感器数据处理流程
   - 实验开始/结束状态管理

3. **数据流程**：
   ```
   开始实验 → 接收传感器数据 → 连续计数判断 → 达到阈值 → 自动锁定
   ```

#### P1: 锁定后测距功能（完善现有功能）
**需求描述**：
- 锁定方向卡片自动显示测距按钮
- 点击测距按钮后，记录测距按钮按下后最近3次传入的对应方向读数
- 计算平均值并取整，作为最终测距结果
- 更新卡片显示固定距离值
- 测距完成后回到待测状态，但该方向不再参与实时高亮计算

**实现方案**：
1. **修复现有bug**：
   - 检查测距数据收集逻辑是否正确
   - 验证测距结果显示和状态更新

2. **完善测距流程**：
   - 优化测距按钮显示时机
   - 改进测距状态反馈
   - 完善测距完成后的状态管理

#### P2: AutoRun功能（自动化升级）
**需求描述**：
- 将主页面"开启/关闭锁定"滑块按钮重命名为"AutoRun"
- AutoRun默认关闭状态
- 开启AutoRun后，在"开始实验"后自动执行锁定→测距→下一个方向的完整流程
- 无需手动点击测距按钮，直接自动完成所有方向的测试

**实现方案**：
1. **UI层面**：
   - 重命名"开启/关闭锁定"为"AutoRun"
   - 添加AutoRun状态指示

2. **逻辑层面**：
   - 新增AutoRun状态管理（`autoRunEnabled`）
   - 扩展锁定完成处理逻辑
   - 自动触发测距流程
   - 智能选择下一个待测方向

---

## 实施顺序建议

### Phase 1: 基础自动化 (P0 + P1修复)
1. **实现自动锁定功能**：
   - 添加"开始实验"按钮UI
   - 实现实验状态管理
   - 集成自动锁定逻辑到数据处理流程

2. **完善测距功能**：
   - 检查并修复现有测距bug
   - 优化测距流程和用户体验

### Phase 2: 高级自动化 (P2)
1. **实现AutoRun功能**：
   - 重命名UI控件
   - 实现自动测距流程
   - 添加智能方向选择逻辑

---

## 预期效果

### 用户体验目标
1. **简化操作**：从手动逐个方向测试，到一键启动全自动测试
2. **提高效率**：减少人工干预，加快测试速度
3. **状态清晰**：实时显示测试进度和当前状态
4. **错误容错**：完善的异常处理和状态恢复

### 技术实现目标
1. **模块化设计**：功能独立，可单独开关
2. **状态一致性**：完善的实验状态管理
3. **性能优化**：高效的数据处理和UI更新
4. **可维护性**：清晰的代码结构和注释

---

## 风险评估

### 潜在风险
1. **状态管理复杂性**：多状态并发可能导致状态不一致
2. **用户操作冲突**：自动流程中用户手动操作可能造成干扰
3. **性能影响**：频繁的数据处理可能影响UI响应

### 缓解措施
1. **状态机设计**：使用明确的状态机管理实验流程
2. **操作锁定**：实验运行时锁定相关手动操作
3. **异步处理**：合理使用异步处理避免阻塞UI

---

## 已发现的问题 (待下一期修复)

### 模拟按钮禁用状态UI更新问题
**问题描述**：
- 模拟数据和模拟锁定按钮在BLE连接成功后，功能层面已被禁用（点击无响应）
- 但UI层面无法正确显示禁用状态（禁用光标、透明度等视觉反馈）
- 需要用户手动刷新页面或触发其他操作才能正确显示禁用状态

**影响范围**：
- 用户体验：按钮看起来仍然可用，但实际点击无效
- 视觉一致性：UI状态与实际功能状态不匹配

**临时解决方案**：
- 已在事件处理层添加功能禁用保护
- 按钮点击时会输出明确的禁用提示信息
- 用户可以通过查看控制台日志了解按钮已被禁用

**计划修复时间**：下一期迭代